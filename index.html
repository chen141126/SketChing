<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¹ªå¸«é€²åº¦ç®¡ç† PWA (Phase 22)</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png"> 
    <!-- å¼•å…¥ Confetti ç‰¹æ•ˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š --- */
        :root {
            --bg-color: #FDFCF8;
            --primary-color: #8D6E63;
            --primary-dark: #5D4037;
            --dark-text: #4E342E;
            --light-text: #A1887F;
            --accent-color: #D7CCC8;
            --card-bg: #FFFFFF;
            --tag-urgent: #FFEBEE;
            --tag-text-urgent: #C62828;
            --tag-normal: #E3F2FD;
            --tag-text-normal: #1565C0;
            --rest-day-green: #E8F5E9;
            --deadline-text: #B71C1C;
            --border-radius: 16px;
            --shadow-sm: 0 2px 8px rgba(93, 64, 55, 0.08);
            --shadow-md: 0 4px 12px rgba(93, 64, 55, 0.15);
            --shadow-float: 0 8px 24px rgba(93, 64, 55, 0.25);
            --sidebar-width: 300px;
            
            /* Reward System Latte Theme */
            --latte-bg: #F5F0EB;
            --latte-card: #FFF8F3;
            --latte-accent: #BCAAA4;
            --latte-dark: #4E342E;
            --latte-redeem-bg: #5D4037;
            --latte-redeem-text: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Noto Sans TC', 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--dark-text);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none;
        }

        /* --- Header --- */
        header {
            padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
            background-color: rgba(253, 252, 248, 0.98);
            z-index: 10; border-bottom: 1px solid var(--accent-color);
        }

        .main-content {
            flex: 1; overflow-y: auto; padding: 0 16px 100px 16px; position: relative;
        }

        /* --- Page Layout --- */
        .page {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            z-index: 2000;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .page-header {
            padding: 16px 20px;
            background: rgba(253, 252, 248, 0.98);
            border-bottom: 1px solid var(--accent-color);
            display: flex; align-items: center; justify-content: space-between;
            flex-shrink: 0;
        }
        .page-title { font-weight: 700; font-size: 1.1rem; color: var(--dark-text); }
        .page-body {
            flex: 1; overflow-y: auto; padding: 20px;
        }
        
        /* Settings Sections */
        .settings-section {
            background: #FFF; border-radius: 12px;
            padding: 16px; margin-bottom: 20px;
            box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05);
        }
        .settings-section h3 {
            margin-top: 0; margin-bottom: 12px;
            color: var(--primary-color); font-size: 1rem; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Components --- */
        .icon-btn {
            background: none; border: none; color: var(--primary-color);
            font-size: 1.2rem; cursor: pointer; padding: 8px; border-radius: 50%;
        }
        .icon-btn:active { background-color: var(--accent-color); }
        
        .month-selector {
            display: flex; align-items: center; gap: 12px;
            font-weight: 700; font-size: 1.1rem; cursor: pointer;
        }

        /* Task Card & Carousel */
        .current-task-container { margin-top: 16px; position: relative; min-height: 80px; }
        .task-card {
            background: var(--card-bg); border-radius: var(--border-radius);
            padding: 16px; box-shadow: var(--shadow-sm);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s;
            position: relative;
        }
        .task-card:active { transform: scale(0.98); }
        
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; }
        .tag-pill-small {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; 
            font-weight: 700; white-space: nowrap; color: #333;
        }

        .carousel-arrow {
            padding: 12px; color: var(--light-text); cursor: pointer; font-size: 1.2rem;
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            z-index: 5;
        }
        
        /* --- Advanced Calendar --- */
        .calendar-container { margin-top: 24px; position: relative; }
        
        .week-header {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-size: 0.8rem; color: var(--light-text);
            margin-bottom: 8px; font-weight: 600;
        }

        .calendar-week-row { position: relative; height: 110px; margin-bottom: 4px; }

        .week-grid-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 4px; z-index: 1;
        }
        .day-cell {
            background: var(--card-bg); border-radius: 8px; padding: 4px;
            position: relative; overflow: hidden;
            transition: background 0.2s;
        }
        .day-cell.rest-day { background-color: var(--rest-day-green); cursor: pointer; }
        .day-cell.drag-highlight { border: 2px solid var(--primary-color); background-color: rgba(141, 110, 99, 0.1); }
        .day-cell.not-current-month { opacity: 0.4; }
        
        .day-number { font-size: 0.8rem; font-weight: 600; color: var(--light-text); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .day-number.today-circle { background-color: var(--primary-color); color: white; }
        
        .deadline-flag {
            position: absolute; top: 2px; right: 2px;
            color: var(--deadline-text); font-size: 0.8rem;
            cursor: pointer; z-index: 20; display: flex; align-items: center; gap: 2px;
        }
        .deadline-count {
            font-size: 0.7rem; font-weight: 700; background: var(--tag-urgent); 
            padding: 0 4px; border-radius: 4px; color: var(--deadline-text);
        }
        .deadline-popover {
            position: absolute; background: white; border: 1px solid var(--accent-color);
            padding: 10px; border-radius: 8px; box-shadow: var(--shadow-md);
            z-index: 500; min-width: 160px; pointer-events: auto;
        }
        .deadline-popover.pop-left { right: 0; left: auto; }

        .week-task-layer {
            position: absolute; top: 24px; left: 0; right: 0; bottom: 0;
            z-index: 10; pointer-events: none;
        }

        .abs-task-bar {
            position: absolute; height: 20px; border-radius: 4px;
            font-size: 0.7rem; padding: 0 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: #333; font-weight: 500; cursor: grab;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            pointer-events: auto; line-height: 20px;
            transition: transform 0.1s;
            touch-action: none;
        }
        .abs-task-bar.completed { 
            opacity: 0.8; text-decoration: line-through; 
            background-color: #CFD8DC !important; color: #546E7A !important;
        }
        .abs-task-bar.paused { 
            background-color: #E0E0E0 !important; color: #616161 !important; 
            border: 1px dashed #BDBDBD;
        }
        .abs-task-bar:active { cursor: grabbing; transform: scale(1.02); z-index: 50; }
        
        .drag-ghost {
            position: fixed; pointer-events: none; z-index: 6000;
            opacity: 0.8; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }

        /* Sidebar - Increased Z-Index to cover Reward Page (2500) */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(62, 39, 35, 0.4); z-index: 5000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }

        .sidebar {
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 85%; max-width: var(--sidebar-width);
            background: var(--card-bg); z-index: 5001;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: var(--shadow-float);
        }
        .sidebar.open { transform: translateX(0); }

        .sidebar-tabs { display: flex; background: var(--bg-color); border-bottom: 1px solid var(--accent-color); }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: none;
            font-weight: 700; color: var(--light-text);
            border-bottom: 3px solid transparent; cursor: pointer;
        }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        
        .sidebar-content-area { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 70px; }
        
        .sidebar-footer {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 60px; background: var(--bg-color);
            border-top: 1px solid var(--accent-color);
            display: grid; grid-template-columns: repeat(5, 1fr);
            align-items: center; justify-items: center;
        }

        .sortable-item {
            background: var(--bg-color); border: 1px solid var(--accent-color);
            padding: 10px; border-radius: 8px; margin-bottom: 8px;
            cursor: grab; display: flex; justify-content: space-between; align-items: center;
            transition: background 0.2s, transform 0.1s;
            touch-action: none;
        }
        .sortable-item.dragging { opacity: 0.5; background: #EEE; }
        .sortable-item.drag-over-target { border: 2px dashed var(--primary-color); }

        /* FAB & Modals */
        .fab-container { position: fixed; bottom: 24px; right: 24px; z-index: 80; display: flex; flex-direction: column; align-items: center; gap: 12px; transition: opacity 0.3s; }
        .fab {
            width: 56px; height: 56px; background-color: var(--primary-color); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: var(--shadow-float); border: none; cursor: pointer;
        }
        .fab-menu {
            display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px;
            opacity: 0; transform: translateY(20px); pointer-events: none; transition: all 0.2s;
        }
        .fab-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .fab-mini-btn {
            background: #FFF; color: var(--primary-color); border: none;
            padding: 10px 16px; border-radius: 20px; box-shadow: var(--shadow-md);
            font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }

        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        /* Higher Z-Index for critical modals */
        .modal.z-high { z-index: 6000; }
        .modal.z-high .modal-card { z-index: 6001; }
        
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-overlay-bg { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); }
        .modal-card {
            background: #FFF; width: 90%; max-width: 400px; border-radius: 20px;
            z-index: 3001; box-shadow: var(--shadow-float); transform: translateY(20px); transition: transform 0.3s;
            display: flex; flex-direction: column; max-height: 90vh;
        }
        .modal.active .modal-card { transform: translateY(0); }
        .modal-header, .modal-footer { padding: 16px 20px; }
        .modal-header { border-bottom: 1px solid var(--accent-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--accent-color); border-radius: 8px; margin-bottom: 12px; }
        .btn { padding: 12px; border-radius: 10px; border:none; font-weight:700; cursor:pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #66BB6A; color: white; }
        .btn-warning { background: #FFB74D; color: white; }
        .btn-danger { background: #EF5350; color: white; }
        .btn-secondary { background: transparent; border: 1px solid var(--accent-color); color: var(--light-text); }
        
        .settings-item-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .checkbox-pill { position: relative; }
        .checkbox-pill input { position: absolute; opacity: 0; }
        .checkbox-pill label {
            display: block; padding: 6px 12px; background: var(--bg-color); border: 1px solid var(--accent-color);
            border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }
        .checkbox-pill input:checked + label { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .multi-tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; margin-bottom: 12px; }
        .tag-pill-check { display: none; }
        .tag-pill-label {
            padding: 6px 12px; border-radius: 20px; border: 1px solid var(--accent-color);
            cursor: pointer; font-size: 0.85rem; user-select: none; transition: all 0.2s;
            background: var(--bg-color);
        }
        
        .sub-item-view-list { margin-bottom: 12px; border: 1px solid #EEE; border-radius: 8px; overflow: hidden; }
        .sub-item-view-row { 
            padding: 8px 12px; border-bottom: 1px solid #EEE; 
            display: flex; align-items: center; gap: 8px; 
            background: #FAFAFA; color: #666; font-size: 0.9rem; cursor: pointer;
        }
        .sub-item-view-row:last-child { border-bottom: none; }
        .sub-item-view-row.done { text-decoration: line-through; opacity: 0.6; }

        .sub-item-edit-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .sub-task-item { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px; background: #F8F9FA; border-radius: 8px; border: 1px solid #EEE;
        }
        .sub-task-item-content { flex: 1; margin: 0 10px; }
        .sub-task-item-input { width: 100%; border: 1px solid var(--primary-color); border-radius: 4px; padding: 4px; }
        .btn-icon-xs { padding: 6px; font-size: 0.9rem; color: var(--light-text); background: none; border: none; cursor: pointer; }
        
        .template-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; background: #F8F9FA; border: 1px solid #EEE;
            border-radius: 8px; margin-bottom: 8px;
        }
        .template-content-preview {
            font-size: 0.8rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;
        }
        
        #completionOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #completionOverlay.active { opacity: 1; pointer-events: auto; }
        .celebration-title { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 10px; font-weight: 800; }
        .celebration-stat { font-size: 1.2rem; color: var(--dark-text); background: #FFF; padding: 10px 20px; border-radius: 20px; box-shadow: var(--shadow-md); }

        .archive-group-title {
            background: var(--accent-color); color: var(--dark-text);
            padding: 8px 12px; border-radius: 8px; font-weight: 700; margin: 16px 0 8px 0;
            font-size: 0.9rem;
        }
        
        /* Advanced Bottom Sheet - Phase 18 Fix: Increased Z-index to > Sidebar (5001) */
        .bottom-sheet {
            position: fixed; left: 0; right: 0; bottom: 0;
            background: #FFF; border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 5201;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; padding: 0 20px 20px 20px;
            max-height: 40vh; /* Default */
        }
        .bottom-sheet.active { transform: translateY(0); }
        .bottom-sheet.expanded { max-height: 85vh; }
        .bottom-sheet.has-subtasks { padding-bottom: 40px; min-height: 50vh; } 
        
        .sheet-content { flex: 1; overflow-y: auto; padding-bottom: 80px; }

        /* Overlay MUST be lower than Bottom Sheet (5201 > 5200), but higher than Sidebar (5001) */
        .bottom-sheet-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 5200;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .bottom-sheet-overlay.active { opacity: 1; pointer-events: auto; }
        
        .sheet-handle-area { width: 100%; height: 30px; display: flex; justify-content: center; align-items: center; cursor: ns-resize; flex-shrink: 0; }
        .sheet-handle { width: 40px; height: 5px; background-color: var(--accent-color); border-radius: 10px; }
        
        .sheet-actions {
            display: none; 
            margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
            grid-template-columns: 1fr 1fr;
            grid-template-areas: "complete complete" "edit lock" "pause delete";
            gap: 12px;
        }
        .bottom-sheet.expanded .sheet-actions { display: grid; }
        
        .btn-action-complete { grid-area: complete; }
        .btn-action-edit { grid-area: edit; }
        .btn-action-lock { grid-area: lock; }
        .btn-action-pause { grid-area: pause; }
        .btn-action-delete { grid-area: delete; }
        
        .time-adjuster { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .adjust-btn { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--primary-color); background: none; color: var(--primary-color); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .current-time-log { font-size: 2rem; font-weight: 800; color: var(--dark-text); }

        .sheet-sub-items-container { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        .sheet-sub-item-row { 
            display: flex; align-items: center; gap: 10px; padding: 10px; 
            background: #F5F5F5; border-radius: 8px; cursor: pointer;
        }
        .sheet-checkbox { width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .sheet-checkbox.checked { background: var(--primary-color); }
        .sheet-checkbox.checked::after { content: 'âœ”'; color: white; font-size: 0.8rem; }

        /* --- PHASE 16/17/18: REWARD SYSTEM CSS --- */
        .reward-page-content {
            background: var(--latte-bg); min-height: 100%; display: flex; flex-direction: column;
        }
        .reward-card {
            background: var(--card-bg); border-radius: 20px; padding: 20px; margin: 20px;
            box-shadow: var(--shadow-md);
        }
        /* Phase 19: Height limit for stats (approx 2 items) */
        #rewardBalanceList {
            max-height: 110px; overflow-y: auto; padding-right: 4px;
        }
        
        /* Phase 20: Year Selector UI Update - CSS Grid */
        .reward-year-selector {
            display: grid;
            grid-template-columns: 40px 1fr 40px; /* Spacer | Center Controls | Right Button */
            align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #EEE;
        }
        .year-controls-center {
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .icon-btn-small { background:none; border:none; color:var(--light-text); cursor:pointer; font-size:1rem; padding:4px; }
        
        .reward-summary-title {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.1rem; font-weight: 800; color: var(--latte-dark); margin-bottom: 12px;
        }
        .segmented-control {
            display: flex; background: #EEE; border-radius: 12px; padding: 2px;
        }
        .segmented-btn {
            padding: 4px 10px; font-size: 0.75rem; border-radius: 10px; border: none; background: transparent; color: #888; font-weight: 700; cursor: pointer;
        }
        .segmented-btn.active { background: #FFF; color: var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .reward-stat-row {
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 6px; border-radius: 8px;
            cursor: pointer; transition: background 0.2s;
        }
        .reward-stat-row:hover, .reward-stat-row.active { background: #F5F5F5; }
        .reward-stat-name { font-weight: 600; color: var(--latte-dark); display: flex; align-items: center; gap: 8px; }
        .reward-stat-val { font-weight: 700; color: var(--primary-color); }
        .reward-year-header { margin: 12px 0 6px 0; font-weight: 700; color: #888; font-size: 0.85rem; border-bottom: 1px solid #EEE; padding-bottom: 4px; }
        
        .reward-log-container { flex: 1; overflow-y: auto; padding: 0 20px 80px 20px; }
        
        /* Phase 19: Grid Layout for Reward Items */
        .reward-log-item {
            background: #FFF; border-radius: 12px; padding: 12px 16px; margin-bottom: 10px;
            box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.03);
            cursor: pointer;
            display: grid;
            grid-template-columns: 40px minmax(80px, 1fr) 2fr minmax(60px, auto);
            grid-template-rows: auto auto;
            gap: 2px 12px;
            align-items: center;
        }
        .reward-log-item:active { transform: scale(0.98); }
        .reward-log-item.redeem {
            background: var(--latte-redeem-bg); color: var(--latte-redeem-text);
        }
        
        /* Grid Areas */
        .log-grid-icon { grid-row: 1 / 3; grid-column: 1; align-self: center; }
        .log-grid-name { grid-row: 1; grid-column: 2; font-weight: 700; font-size: 0.95rem; align-self: end; }
        .log-grid-date { grid-row: 2; grid-column: 2; font-size: 0.8rem; opacity: 0.8; align-self: start; }
        .log-grid-note { grid-row: 1 / 3; grid-column: 3; justify-self: center; text-align: center; font-size: 1.1rem; font-weight: 700; opacity: 0.9; }
        .log-grid-amount { grid-row: 1; grid-column: 4; text-align: right; font-weight: 800; font-size: 1.2rem; align-self: end; }
        .log-grid-type { grid-row: 2; grid-column: 4; text-align: right; font-size: 0.75rem; align-self: start; }

        .reward-log-icon {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            background: var(--latte-bg); font-size: 1.2rem; color: var(--primary-color);
        }
        .reward-log-item.redeem .reward-log-icon {
            background: rgba(255,255,255,0.2); color: #FFF;
        }
        
        /* Transaction Modal Specifics */
        .tab-group { display: flex; background: #EEE; border-radius: 20px; padding: 4px; margin-bottom: 16px; }
        .tab-pill {
            flex: 1; text-align: center; padding: 8px; border-radius: 16px; 
            font-weight: 700; cursor: pointer; color: #888; transition: all 0.2s;
        }
        .tab-pill.active { background: #FFF; color: var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-pill.active-redeem { background: var(--latte-redeem-bg); color: #FFF; }

        /* Custom Numpad */
        .numpad-container {
            position: fixed; bottom: 0; left: 0; right: 0; background: #FFF; 
            border-radius: 24px 24px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            padding: 20px; padding-bottom: 30px; transform: translateY(100%); transition: transform 0.2s; z-index: 4000;
        }
        .numpad-container.active { transform: translateY(0); }
        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .numpad-key {
            padding: 15px; font-size: 1.5rem; font-weight: 700; border-radius: 12px;
            background: #F5F5F5; border: none; cursor: pointer; color: var(--latte-dark);
        }
        .numpad-key:active { background: #E0E0E0; }
        .numpad-confirm {
            grid-column: span 3; background: var(--primary-color); color: #FFF;
            font-size: 1.1rem; padding: 12px; margin-top: 10px;
        }

        /* Category Grid */
        .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 10px; }
        .category-item {
            position: relative;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            background: #FFF; padding: 12px 6px; border-radius: 12px; border: 2px solid transparent;
            cursor: pointer; box-shadow: var(--shadow-sm);
        }
        .category-item.selected { border-color: var(--primary-color); background: #FDFCF8; }
        .category-icon { font-size: 1.5rem; color: var(--primary-color); }
        .category-name { font-size: 0.8rem; font-weight: 700; color: var(--dark-text); text-align: center; }
        .category-edit-btn {
            position: absolute; top: -5px; right: -5px; width: 24px; height: 24px;
            background: #FFF; border: 1px solid #EEE; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #888; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Icon Picker */
        .icon-picker-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-height: 150px; overflow-y: auto; padding: 4px; }
        .icon-picker-item {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: #F5F5F5; border-radius: 8px; cursor: pointer; font-size: 1.1rem;
            color: #666; border: 2px solid transparent;
        }
        .icon-picker-item.selected { border-color: var(--primary-color); color: var(--primary-color); background: #FFF; }

        .reward-sub-page { display: none; height: 100%; flex-direction: column; }
        .reward-sub-page.active { display: flex; }
        
        .archived-section-title {
            margin-top: 20px; font-size: 0.85rem; color: #999; font-weight: 700; 
            padding-bottom: 8px; border-bottom: 1px solid #EEE; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- PHASE 21: STATS PAGE CSS --- */
        .stats-control-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 10px;
        }
        .stats-card {
            background: #FFF; border-radius: 16px; padding: 16px; margin-bottom: 16px;
            box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.02);
        }
        .stats-val-big { font-size: 1.8rem; font-weight: 800; color: var(--primary-dark); }
        .stats-label { font-size: 0.85rem; color: var(--light-text); font-weight: 700; margin-bottom: 4px; display:block; }
        
        .css-bar-container { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
        .css-bar-bg { background: #F0F0F0; height: 8px; border-radius: 4px; overflow: hidden; position: relative; width: 100%; }
        .css-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        
        .pie-chart-container {
            display: flex; justify-content: center; margin: 10px 0;
        }
        .css-pie-chart {
            width: 140px; height: 140px; border-radius: 50%;
            position: relative;
            /* Conic gradient injected via JS */
        }
        .css-pie-hole {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; background: #FFF; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: var(--primary-color); font-size: 0.9rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #555; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; }

        .rank-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #EEE;
        }
        .rank-bar-bg { flex: 1; height: 6px; background: #F5F5F5; border-radius: 3px; margin: 0 10px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: var(--primary-color); border-radius: 3px; }

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- Phase 11: Standalone Settings Page -->
    <div id="settingsPage" class="page" style="display:none;">
        <div class="page-header">
            <button class="icon-btn" onclick="window.closeSettings()"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
            <span class="page-title">è¨­å®š</span>
            <div style="width:32px;"></div> <!-- Spacer -->
        </div>
        <div class="page-body">
            <!-- Basic Settings -->
            <div class="settings-section">
                <h3>åŸºæœ¬è¨­å®š</h3>
                <label>æ¯æ—¥å·¥æ™‚ (å°æ™‚)</label>
                <input type="number" id="pgSettingDailyHours" class="form-control" onchange="window.updateSetting('dailyWorkHours', this.value)">
                <label>æœˆä¼‘é¡åº¦ (å¤©)</label>
                <input type="number" id="pgSettingMonthlyQuota" class="form-control" onchange="window.updateSetting('monthlyQuota', this.value)">
            </div>

            <!-- Estimation Items -->
            <div class="settings-section">
                <h3>
                    ä¼°åƒ¹é …ç›® 
                    <button type="button" class="btn btn-secondary" style="padding:4px 10px; font-size:0.8rem;" onclick="window.addEstItem()">+ æ–°å¢</button>
                </h3>
                <div id="pgEstList"></div>
            </div>

            <!-- Templates -->
            <div class="settings-section">
                 <h3>
                    å­é …ç›®æ¨¡æ¿ 
                    <button type="button" class="btn btn-secondary" style="padding:4px 10px; font-size:0.8rem;" onclick="window.openTemplateInputModal(null)">+ æ–°å¢</button>
                </h3>
                <div id="pgTemplateList"></div>
            </div>

            <!-- Phase 22: Cloud Sync Settings -->
            <div class="settings-section">
                <h3>â˜ï¸ é›²ç«¯å‚™ä»½è¨­å®š (Firebase BYOK)</h3>
                <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">è«‹è¼¸å…¥æ‚¨è‡ªå·±çš„ Firebase è¨­å®šä»¥å•Ÿç”¨é›²ç«¯åŒæ­¥ã€‚</p>
                <input type="password" id="fbApiKey" class="form-control" placeholder="API Key">
                <input type="text" id="fbAuthDomain" class="form-control" placeholder="Auth Domain">
                <input type="text" id="fbProjectId" class="form-control" placeholder="Project ID">
                <input type="text" id="fbAppId" class="form-control" placeholder="App ID">
                
                <div id="fbConnectionStatus" style="font-size:0.8rem; font-weight:700; margin-bottom:10px; color:#AAA;">ç‹€æ…‹: æœªè¨­å®š</div>

                <div style="display:flex; flex-direction:column; gap:8px;">
                    <button class="btn btn-secondary" onclick="window.CloudSync.saveConfig()">å„²å­˜è¨­å®šä¸¦é€£ç·š</button>
                    <button class="btn btn-primary" id="fbLoginBtn" style="display:none;" onclick="window.CloudSync.login()"><i class="fa-brands fa-google"></i> Google ç™»å…¥</button>
                    <button class="btn btn-secondary" id="fbLogoutBtn" style="display:none;" onclick="window.CloudSync.logout()">ç™»å‡º</button>
                    
                    <div id="fbSyncActions" style="display:none; flex-direction:column; gap:8px; margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
                        <button class="btn btn-success" onclick="window.CloudSync.upload()"><i class="fa-solid fa-cloud-arrow-up"></i> æ‰‹å‹•ä¸Šå‚³ (è¦†è“‹é›²ç«¯)</button>
                        <button class="btn btn-warning" onclick="window.CloudSync.download()"><i class="fa-solid fa-cloud-arrow-down"></i> å¾é›²ç«¯ä¸‹è¼‰ (è¦†è“‹æœ¬æ©Ÿ)</button>
                    </div>
                </div>
            </div>
            
            <div style="text-align:center; color:#AAA; font-size:0.8rem; margin-top:20px;">
                Sketch-Ching v22.0
            </div>
        </div>
    </div>

    <!-- PHASE 21: STATISTICS PAGE -->
    <div id="statsPage" class="page" style="display:none; background: var(--latte-bg); z-index: 2500;">
        <div class="page-header" style="background:var(--latte-bg); border-bottom-color: rgba(0,0,0,0.05);">
            <div style="width:32px;"></div> <!-- Spacer -->
            <span class="page-title" style="color:var(--latte-dark)">çµ±è¨ˆåˆ†æ</span>
            <div style="width:32px;"></div> <!-- Spacer -->
        </div>
        
        <div class="page-body">
            <!-- Top Control Bar -->
            <div class="stats-control-bar">
                <button class="icon-btn" onclick="window.toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="icon-btn-small" onclick="window.changeStatsDate(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <div style="text-align:center; cursor:pointer;" onclick="window.resetStatsDate()" oncontextmenu="window.toggleStatsViewMode(); return false;">
                        <div id="statsDateDisplay" style="font-weight:800; font-size:1.1rem; color:var(--dark-text);">2026</div>
                        <div id="statsViewModeDisplay" style="font-size:0.7rem; color:var(--light-text);">Year View</div>
                    </div>
                    <button class="icon-btn-small" onclick="window.changeStatsDate(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <button class="icon-btn" onclick="window.toggleGlassHeart()" id="glassHeartBtn">
                    ğŸ’”
                </button>
            </div>

            <!-- Tabs -->
            <div class="tab-group">
                <div id="tabEconomy" class="tab-pill active" onclick="window.switchStatsTab('economy')">ç…‰é‡‘æˆæœ</div>
                <div id="tabPerformance" class="tab-pill" onclick="window.switchStatsTab('performance')">æˆ°é¬¥æ•¸å€¼</div>
            </div>

            <!-- Tab Content: Economy -->
            <div id="statsContentEconomy">
                <div class="stats-card">
                    <span class="stats-label">ç¸½æ”¶ç›Š (Total Revenue)</span>
                    <div class="stats-val-big" id="statsTotalRevenue">NT$ 0</div>
                </div>

                <div class="stats-card">
                    <span class="stats-label">æ™‚è–ªå¤§å¯¦è©± (Real Hourly Rate)</span>
                    <div class="stats-val-big" id="statsRealHourly" style="margin-bottom:8px;">$0 / hr</div>
                    
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#888;">
                        <span>é ä¼° (Est)</span>
                        <span id="valEstRate">$0</span>
                    </div>
                    <div class="css-bar-bg"><div class="css-bar-fill" id="barEstRate" style="width:0%; background:#BDBDBD;"></div></div>
                    
                    <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#888; margin-top:6px;">
                        <span>çœŸå¯¦ (Real)</span>
                        <span id="valRealRate">$0</span>
                    </div>
                    <div class="css-bar-bg"><div class="css-bar-fill" id="barRealRate" style="width:0%; background:#42A5F5;"></div></div>
                </div>

                <div class="stats-card">
                    <span class="stats-label">é‡‘ä¸»åˆ†æ (Revenue by Tag)</span>
                    <div class="pie-chart-container">
                        <div class="css-pie-chart" id="revenuePieChart">
                            <div class="css-pie-hole">Revenue</div>
                        </div>
                    </div>
                    <div class="legend-grid" id="revenueLegend"></div>
                </div>
            </div>

            <!-- Tab Content: Performance -->
            <div id="statsContentPerformance" style="display:none;">
                <div class="stats-card">
                    <span class="stats-label">çˆ†è‚æŒ‡æ•¸ (Total Grind)</span>
                    <div style="display:flex; justify-content:space-around; text-align:center; margin-top:10px;">
                        <div>
                            <div class="stats-val-big" id="statsTotalHours">0h</div>
                            <div style="font-size:0.8rem; color:#888;">ç¸½å·¥æ™‚</div>
                        </div>
                        <div>
                            <div class="stats-val-big" id="statsTotalTasks">0</div>
                            <div style="font-size:0.8rem; color:#888;">å®Œæˆä»»å‹™</div>
                        </div>
                    </div>
                </div>

                <div class="stats-card">
                    <span class="stats-label">é è¨€å®¶æº–ç¢ºç‡ (Actual / Est)</span>
                    <div class="stats-val-big" id="statsAccuracy">100%</div>
                    <div style="font-size:0.8rem; color:#888; margin-top:4px;">
                        > 100% ä»£è¡¨è¶…æ™‚ (Overtime)
                    </div>
                </div>

                <div class="stats-card">
                    <span class="stats-label">æ¨™ç±¤é »ç‡ (Top 5 Tags)</span>
                    <div id="statsTagRank" style="margin-top:10px;"></div>
                </div>
            </div>
            
            <div style="height: 60px;"></div>
        </div>
    </div>

    <!-- PHASE 16/17/18/19/20: REWARD PAGE -->
    <div id="rewardPage" class="page" style="display:none; background: var(--latte-bg); z-index: 2500;">
        <!-- Common Header -->
        <div class="page-header" style="background:var(--latte-bg); border-bottom-color: rgba(0,0,0,0.05);">
            <!-- Phase 17: Dashboard Header Button opens Sidebar -->
            <button class="icon-btn" id="rewardHeaderLeftBtn" onclick="window.toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <span class="page-title" style="color:var(--latte-dark)">çå‹µå…Œæ›</span>
            <div style="width:32px;"></div>
        </div>

        <!-- Screen A: Dashboard -->
        <div id="rewardDashboard" class="reward-sub-page active">
            <div class="reward-card">
                <!-- Phase 20 Update: Year Selector UI Adjustment -->
                <div class="reward-year-selector">
                    <!-- Left Spacer -->
                    <div></div>
                    
                    <!-- Center: Year Controls -->
                    <div class="year-controls-center">
                        <button class="icon-btn-small" onclick="window.changeRewardYear(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="rewardYearDisplay" onclick="window.resetRewardYear()" style="font-weight:800; font-size:1.1rem; width:80px; text-align:center; cursor:pointer;" title="å›åˆ°ä»Šå¹´">2026</span>
                        <button class="icon-btn-small" onclick="window.changeRewardYear(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    
                    <!-- Right: All Button -->
                    <div style="text-align:right;">
                        <button class="icon-btn-small" onclick="window.setRewardYear('all')" style="margin-left:8px; color:var(--primary-color);"><i class="fa-solid fa-layer-group"></i></button>
                    </div>
                </div>

                <div class="reward-summary-title">
                    <span id="rewardStatTitle">æœªå…Œæ›çå‹µ</span>
                    <div class="segmented-control">
                        <button class="segmented-btn active" id="segBalance" onclick="window.switchRewardDashboardMode('balance')">é¤˜é¡</button>
                        <button class="segmented-btn" id="segTotal" onclick="window.switchRewardDashboardMode('total')">ç¸½è¨ˆ</button>
                    </div>
                </div>
                <div id="rewardBalanceList"></div>
            </div>
            <div style="padding: 0 20px 8px 20px; font-size:0.8rem; color:#888; font-weight:700; display:flex; justify-content:space-between;">
                <span>äº¤æ˜“æ˜ç´°</span>
                <span id="rewardLogFilterTag" style="display:none; color:var(--primary-color); cursor:pointer;" onclick="window.clearRewardFilter()"><i class="fa-solid fa-filter-circle-xmark"></i> æ¸…é™¤ç¯©é¸</span>
            </div>
            <div id="rewardLogList" class="reward-log-container"></div>
            
            <div class="fab-container" style="position:absolute; bottom:24px; right:24px;">
                <button type="button" class="fab" onclick="window.openRewardTransactionModal()">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Screen B: Transaction Editor -->
        <div id="rewardTransaction" class="reward-sub-page" style="padding: 20px;">
            <div class="tab-group">
                <div id="tabEarn" class="tab-pill active" onclick="window.switchRewardTab('earn')">ç²å–çå‹µ</div>
                <div id="tabRedeem" class="tab-pill" onclick="window.switchRewardTab('redeem')">å…Œæ›çå‹µ</div>
            </div>

            <label>æ—¥æœŸ</label>
            <button type="button" id="rewardDateBtn" class="form-control" style="text-align:left; background:#FFF;" onclick="window.openRewardDateModal()"></button>
            <input type="hidden" id="rewardDateInput">

            <label>çå‹µé …ç›®</label>
            <div id="selectedCategoryDisplay" class="form-control" style="background:#FFF; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="window.openCategorySelector()">
                <div style="color:#AAA;">é»æ“Šé¸æ“‡é¡åˆ¥...</div>
            </div>
            <input type="hidden" id="rewardCategoryId">

            <label>æ•¸é‡</label>
            <div id="rewardAmountDisplay" class="form-control" style="background:#FFF; font-size:1.5rem; font-weight:700; text-align:center; padding:15px; cursor:pointer;" onclick="window.openNumpad()">0</div>
            
            <label>å‚™è¨» (é¸å¡«)</label>
            <textarea id="rewardNote" class="form-control" rows="2" placeholder="å¯«é»ä»€éº¼..."></textarea>

            <div style="flex:1"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <!-- Phase 17: Hidden delete button for Edit Mode -->
                <button type="button" class="btn btn-danger" id="btnDeleteLog" style="display:none;" onclick="window.openDeleteLogConfirmation()">åˆªé™¤</button>
                <button type="button" class="btn btn-primary" style="flex:1" onclick="window.submitRewardTransaction()">ç¢ºèª</button>
            </div>
        </div>

        <!-- Screen C: Category Selector -->
        <div id="rewardCategorySelect" class="reward-sub-page" style="padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0">é¸æ“‡é …ç›®</label>
                <button type="button" class="btn btn-secondary" style="padding:4px 10px; font-size:0.8rem;" onclick="window.openCreateCategoryModal()">+ æ–°å¢é …ç›®</button>
            </div>
            <div id="categoryGrid" class="category-grid"></div>
            
            <div class="archived-section-title" onclick="window.toggleArchivedCategories()">
                <span>å·²å°å­˜é …ç›®</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div id="archivedCategoryGrid" class="category-grid" style="display:none;"></div>
        </div>
    </div>

    <!-- CUSTOM NUMPAD OVERLAY -->
    <div class="bottom-sheet-overlay" id="numpadOverlay" onclick="window.closeNumpad()" style="z-index: 3999;"></div>
    <div class="numpad-container" id="customNumpad">
        <div class="numpad-grid">
            <button type="button" class="numpad-key" onclick="window.numpadInput(1)">1</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(2)">2</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(3)">3</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(4)">4</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(5)">5</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(6)">6</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(7)">7</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(8)">8</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(9)">9</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput('.')">.</button>
            <button type="button" class="numpad-key" onclick="window.numpadInput(0)">0</button>
            <button type="button" class="numpad-key" onclick="window.numpadDelete()"><i class="fa-solid fa-delete-left"></i></button>
            <button type="button" class="numpad-key numpad-confirm" onclick="window.closeNumpad()"><i class="fa-solid fa-check"></i> ç¢ºèª</button>
        </div>
    </div>

    <header class="main-content-element">
        <button class="icon-btn" onclick="window.toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
        </button>
        <div class="month-selector" onclick="window.resetToToday()">
            <i class="fa-solid fa-chevron-left icon-btn" onclick="event.stopPropagation(); window.changeMonth(-1)"></i>
            <span id="headerMonthTitle">2026å¹´ 4æœˆ</span>
            <i class="fa-solid fa-chevron-right icon-btn" onclick="event.stopPropagation(); window.changeMonth(1)"></i>
        </div>
        <button class="icon-btn" onclick="window.initData(true)"><i class="fa-solid fa-rotate-right"></i></button>
    </header>

    <div class="main-content main-content-element">
        <div class="current-task-container" id="taskCarousel"></div>

        <div class="calendar-container">
            <div class="week-header">
                <div>é€±ä¸€</div><div>é€±äºŒ</div><div>é€±ä¸‰</div><div>é€±å››</div><div>é€±äº”</div><div>é€±å…­</div><div>é€±æ—¥</div>
            </div>
            <div id="calendarRows"></div>
        </div>
    </div>

    <!-- Completion Celebration Overlay -->
    <div id="completionOverlay" onclick="window.closeCompletionOverlay()">
        <div class="celebration-title">æ­å–œå®Œæˆï¼</div>
        <div class="celebration-stat" id="celebrationStat">æ¯”é æœŸæ—© 2.0 å°æ™‚</div>
        <div style="margin-top:20px; color:#888; font-size:0.9rem;">(é»æ“Šç•«é¢ä»»æ„è™•é—œé–‰)</div>
    </div>

    <div class="fab-container main-content-element">
        <div class="fab-menu" id="fabMenu">
            <button class="fab-mini-btn" onclick="window.openEditModal(); window.toggleFab();">
                <i class="fa-solid fa-pen-nib"></i> æ–°å¢ä»»å‹™
            </button>
            <button class="fab-mini-btn" onclick="window.openRestModal(); window.toggleFab();">
                <i class="fa-solid fa-mug-hot"></i> æ–°å¢ä¼‘æ¯æ—¥
            </button>
        </div>
        <button class="fab" id="fabMainBtn" onclick="window.toggleFab()">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="sidebar-overlay" onclick="window.toggleSidebar()"></div>
    <aside class="sidebar">
        <div class="sidebar-tabs">
            <button class="tab-btn active" onclick="window.switchTab('priority')">æ’åº</button>
            <button class="tab-btn" onclick="window.switchTab('backlog')">å¾…è¾¦</button>
            <button class="tab-btn" onclick="window.switchTab('paused')">æš«åœ</button>
        </div>
        <div class="sidebar-content-area" id="sidebarContent"></div>
        <div class="sidebar-footer">
            <button class="icon-btn" onclick="window.goHome()"><i class="fa-solid fa-house"></i></button>
            <button class="icon-btn" onclick="window.openRewardPage()"><i class="fa-solid fa-gift"></i></button>
            <button class="icon-btn" onclick="window.switchTab('archive')"><i class="fa-solid fa-clock-rotate-left"></i></button>
            <!-- Phase 21: Updated Chart Button -->
            <button class="icon-btn" onclick="window.openStatsPage()"><i class="fa-solid fa-chart-pie"></i></button>
            <button class="icon-btn" onclick="window.openSettings()"><i class="fa-solid fa-gear"></i></button>
        </div>
    </aside>

    <div class="modal" id="confirmDeleteModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('confirmDeleteModal')"></div>
        <div class="modal-card" style="text-align:center; padding:20px;">
            <h3 style="margin-top:0">ç¢ºå®šåˆªé™¤?</h3>
            <p style="color:#666;">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸæ­¤ä»»å‹™ã€‚</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" style="flex:1" onclick="window.closeModal('confirmDeleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" style="flex:1" onclick="window.executeDelete()">åˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- PHASE 15: New Custom Modals for Templates -->
    <div class="modal z-high" id="templateInputModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('templateInputModal')"></div>
        <div class="modal-card">
            <div class="modal-header">
                <span style="font-weight:700;">ç·¨è¼¯æ¨¡æ¿</span>
                <button type="button" class="icon-btn" onclick="window.closeModal('templateInputModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <label>æ¨¡æ¿åç¨±</label>
                <input type="text" id="tplNameInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šä¸€èˆ¬æ’ç•«">
                <label>é …ç›® (é€—è™Ÿåˆ†éš”)</label>
                <input type="text" id="tplContentInput" class="form-control" placeholder="è‰ç¨¿, ç·šç¨¿, å®Œç¨¿">
            </div>
            <div class="modal-footer" style="display:flex; gap:10px;">
                <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeModal('templateInputModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" style="flex:1" onclick="window.saveTemplateFromModal()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal z-high" id="templateDeleteModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('templateDeleteModal')"></div>
        <div class="modal-card" style="text-align:center; padding:20px;">
            <h3 style="margin-top:0">ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿å—ï¼Ÿ</h3>
            <p style="color:#666;">åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeModal('templateDeleteModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" style="flex:1" onclick="window.executeDeleteTemplate()">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- PHASE 16/17/18: Reward Specific Modals -->
    <div class="modal z-high" id="rewardCategoryModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('rewardCategoryModal')"></div>
        <div class="modal-card">
            <div class="modal-header">
                <span style="font-weight:700;" id="catModalTitle">æ–°å¢çå‹µé …ç›®</span>
                <button type="button" class="icon-btn" onclick="window.closeModal('rewardCategoryModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editCatId">
                <label>åç¨±</label>
                <input type="text" id="newCatName" class="form-control" placeholder="ä¾‹å¦‚ï¼šSPAæŒ‰æ‘©">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>å–®ä½</label>
                        <input type="text" id="newCatUnit" class="form-control" placeholder="æ¬¡ã€å°æ™‚">
                    </div>
                    <div>
                        <label>é¡è‰²</label>
                        <input type="color" id="newCatColor" class="form-control" style="height:42px; padding:2px;" value="#8D6E63">
                    </div>
                </div>
                
                <!-- Phase 17: Archive Option -->
                <div id="catArchiveOption" style="margin-bottom:12px; display:none;">
                    <div class="checkbox-pill">
                        <input type="checkbox" id="newCatArchived">
                        <label for="newCatArchived">å°å­˜æ­¤é …ç›® (éš±è—)</label>
                    </div>
                </div>

                <label>åœ–ç¤º</label>
                <div id="iconPickerGrid" class="icon-picker-grid"></div>
                <input type="hidden" id="newCatIcon">
                
                <!-- Phase 18: Delete Button -->
                <button type="button" class="btn btn-danger" id="btnDeleteCategory" style="width:100%; margin-top:20px; display:none;" onclick="window.openDeleteCategoryConfirmation()">åˆªé™¤é …ç›®</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" style="width:100%" onclick="window.saveCategory()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal z-high" id="insufficientFundsModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('insufficientFundsModal')"></div>
        <div class="modal-card" style="text-align:center; padding:20px;">
            <h3 style="margin-top:0; color:var(--deadline-text);">é¤˜é¡ä¸è¶³</h3>
            <p style="color:#666;">æ‚¨çš„é»æ•¸ä¸è¶³ä»¥å…Œæ›æ­¤é …ç›®ï¼Œç¢ºå®šè¦å¼·åˆ¶å…Œæ›å—ï¼Ÿ</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeModal('insufficientFundsModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" style="flex:1" onclick="window.forceSubmitReward()">å¼·åˆ¶åŸ·è¡Œ</button>
            </div>
        </div>
    </div>
    
    <div class="modal z-high" id="rewardDateModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('rewardDateModal')"></div>
        <div class="modal-card">
            <div class="modal-header">é¸æ“‡æ—¥æœŸ</div>
            <div class="modal-body">
                <input type="date" id="rewardDatePicker" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" style="width:100%" onclick="window.confirmRewardDate()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- Phase 17: Log Options Modal -->
    <div class="modal z-high" id="rewardLogOptionsModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('rewardLogOptionsModal')"></div>
        <div class="modal-card" style="text-align:center;">
            <div class="modal-body" style="display:flex; flex-direction:column; gap:10px;">
                <input type="hidden" id="selectedLogId">
                <button type="button" class="btn btn-secondary" onclick="window.editSelectedLog()"><i class="fa-solid fa-pen"></i> ç·¨è¼¯ç´€éŒ„</button>
                <button type="button" class="btn btn-danger" onclick="window.openDeleteLogConfirmation()"><i class="fa-solid fa-trash"></i> åˆªé™¤ç´€éŒ„</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" style="width:100%" onclick="window.closeModal('rewardLogOptionsModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- Phase 18: Safety Modals -->
    <div class="modal z-high" id="confirmDeleteCategoryModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('confirmDeleteCategoryModal')"></div>
        <div class="modal-card" style="text-align:center; padding:20px;">
            <h3 style="margin-top:0;">ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿ</h3>
            <p style="color:#666; margin-bottom:20px;">åˆªé™¤å¾Œï¼Œç›¸é—œçš„äº¤æ˜“ç´€éŒ„å¯èƒ½æœƒé¡¯ç¤ºç‚ºã€ŒæœªçŸ¥é …ç›®ã€ã€‚</p>
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeModal('confirmDeleteCategoryModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" style="flex:1" onclick="window.executeDeleteCategory()">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <div class="modal z-high" id="confirmDeleteLogModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('confirmDeleteLogModal')"></div>
        <div class="modal-card" style="text-align:center; padding:20px;">
            <h3 style="margin-top:0;">ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ</h3>
            <p style="color:#666; margin-bottom:20px;">åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚</p>
            <div style="display:flex; gap:10px;">
                <button type="button" class="btn btn-secondary" style="flex:1" onclick="window.closeModal('confirmDeleteLogModal')">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" style="flex:1" onclick="window.executeDeleteLog()">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT TASK MODAL (View Mode for Sub-items) -->
    <div class="modal" id="addTaskModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('addTaskModal')"></div>
        <div class="modal-card">
            <div class="modal-header">
                <span style="font-weight:700;" id="modalTitleText">æ–°å¢ä»»å‹™</span>
                <button class="icon-btn" onclick="window.closeModal('addTaskModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTaskId">
                <label>ä»»å‹™åç¨±</label>
                <input type="text" id="newTaskTitle" class="form-control" placeholder="ä¾‹å¦‚ï¼šç«‹ç¹ªå§”è¨—">
                
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <label>æ¨™ç±¤ (å¤šé¸)</label>
                    <small style="color:var(--primary-color); cursor:pointer;" onclick="window.openTagManager()">[ç®¡ç†]</small>
                </div>
                <div id="multiTagContainer" class="multi-tag-container"></div>

                <label style="margin-top:12px; display:block;">ä¼°åƒ¹é …ç›® (è‡ªå‹•åŠ ç¸½)</label>
                <div class="checkbox-group" id="newTaskItemsContainer"></div>
                
                <!-- Sub-Items View Only Section -->
                <label style="margin-top:16px; margin-bottom:8px; display:block;">åŸ·è¡Œå­é …ç›®</label>
                <div id="subItemViewList" class="sub-item-view-list"></div>
                <button class="btn btn-secondary" style="width:100%; padding:8px; margin-bottom:16px; font-size:0.9rem;" onclick="window.openSubTaskEditModal()">
                    <i class="fa-solid fa-list-check"></i> ç·¨è¼¯å­é …ç›®æµç¨‹
                </button>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>å ±åƒ¹ (NTD)</label>
                        <input type="number" id="newTaskPrice" class="form-control" onkeyup="window.updateHourlyRate()" placeholder="0">
                    </div>
                    <div style="flex:1">
                        <label>é ä¼°å·¥æ™‚ (h)</label>
                        <input type="number" id="newTaskHours" class="form-control" value="0" onkeyup="window.updateHourlyRate()">
                    </div>
                </div>
                <div style="text-align:right; font-size:0.8rem; color:var(--light-text); margin-bottom:12px;" id="hourlyRateDisplay">é ä¼°æ™‚è–ª: $0</div>

                <label>å‚™è¨»</label>
                <textarea id="newTaskNotes" class="form-control" rows="2"></textarea>
                
                <label>æ­»ç·š (å¯é¸)</label>
                <input type="date" id="newTaskDeadline" class="form-control">
                
                <label>é–å®šæ’ç¨‹ (å¯é¸)</label>
                <input type="date" id="newTaskStartDate" class="form-control">
            </div>
            <div class="modal-footer" style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="window.closeModal('addTaskModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="window.submitNewTask()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- NEW: SUB-ITEM EDIT FLOW MODAL (High Z-Index) -->
    <div class="modal z-high" id="subItemEditModal">
        <div class="modal-overlay-bg" onclick="window.closeSubItemEditModal()"></div>
        <div class="modal-card" style="height: 70vh;">
            <div class="modal-header">
                <span style="font-weight:700;">ç·¨è¼¯æµç¨‹</span>
                <button class="icon-btn" onclick="window.closeSubItemEditModal()"><i class="fa-solid fa-check"></i></button>
            </div>
            <!-- Content dynamic via JS: renderSubTaskEditView -->
            <div class="modal-body" id="subItemEditModalBody" style="display:flex; flex-direction:column;"></div>
        </div>
    </div>

    <div class="modal" id="restModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('restModal')"></div>
        <div class="modal-card">
            <div class="modal-header">
                <span style="font-weight:700;">ä¼‘æ¯æ—¥è¨­å®š</span>
                <button class="icon-btn" onclick="window.closeModal('restModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <label>æ—¥æœŸ</label>
                <input type="date" id="restDateInput" class="form-control">
                
                <div style="margin:10px 0; display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="restFullDay" checked onchange="window.toggleRestTimeInput()">
                    <label for="restFullDay" style="font-weight:600;">å…¨å¤©ä¼‘æ¯</label>
                </div>

                <div id="restTimeContainer" style="display:none; margin-bottom:12px;">
                    <label>æ™‚æ®µ</label>
                    <div style="display:flex; gap:10px;">
                        <input type="time" id="restStart" class="form-control" value="09:00">
                        <input type="time" id="restEnd" class="form-control" value="13:00">
                    </div>
                </div>
                
                <div id="restQuotaInfo" style="background:#E3F2FD; color:#1565C0; padding:10px; border-radius:8px; font-size:0.9rem;">
                    <!-- Content Injected via JS -->
                </div>
            </div>
            <div class="modal-footer" style="display:flex; gap:10px;">
                <button class="btn btn-danger" id="btnDeleteRest" style="display:none;" onclick="window.deleteRestDay()">åˆªé™¤</button>
                <button class="btn btn-primary" onclick="window.submitRestDay()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="modal" id="tagManagerModal">
        <div class="modal-overlay-bg" onclick="window.closeModal('tagManagerModal')"></div>
        <div class="modal-card">
            <div class="modal-header">
                <span>æ¨™ç±¤ç®¡ç†</span>
                <button class="icon-btn" onclick="window.closeModal('tagManagerModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:8px; margin-bottom:15px;">
                    <input type="text" id="newTagName" class="form-control" placeholder="åç¨±" style="margin:0; flex:2;">
                    <input type="color" id="newTagColor" class="form-control" value="#E3F2FD" style="margin:0; flex:1; height:42px; padding:2px;">
                    <button class="btn btn-primary" style="flex:1;" onclick="window.addTag()">æ–°å¢</button>
                </div>
                <div id="tagListContainer"></div>
            </div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="sheetOverlay" onclick="window.closeBottomSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle-area" id="sheetHandle">
            <div class="sheet-handle"></div>
        </div>
        <div class="sheet-content">
            <h3 style="margin:0; color: var(--light-text); font-size: 0.9rem;">å·¥æ™‚ç´€éŒ„</h3>
            <h2 id="sheetTaskTitle" style="margin: 8px 0; font-size: 1.2rem; text-align:center;">Task</h2>
            <div class="time-adjuster">
                <button class="adjust-btn" onclick="window.adjustLog(-0.5)"><i class="fa-solid fa-minus"></i></button>
                <div class="current-time-log" id="sheetLoggedTime">0.0h</div>
                <button class="adjust-btn" onclick="window.adjustLog(0.5)"><i class="fa-solid fa-plus"></i></button>
            </div>
            
            <div id="sheetSubItemsContainer" class="sheet-sub-items-container"></div>

            <p style="text-align:center; color:#888; font-size:0.8rem; margin:12px 0;">å‘ä¸Šæ»‘å‹•ä»¥é¡¯ç¤ºæ›´å¤šé¸é …</p>
            
            <div class="sheet-actions" id="sheetActionsContainer">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Phase 22: Cloud Sync Module
        window.CloudSync = {
            app: null,
            auth: null,
            db: null,
            user: null,
            isReady: false,
            
            init: async function() {
                const configStr = localStorage.getItem('painterApp_firebase_config');
                if(!configStr) return;
                
                try {
                    const config = JSON.parse(configStr);
                    if(config.apiKey && config.projectId) {
                        // Init Firebase
                        this.app = initializeApp(config);
                        this.auth = getAuth(this.app);
                        this.db = getFirestore(this.app);
                        this.isReady = true;
                        
                        // Listen for auth state
                        onAuthStateChanged(this.auth, (user) => {
                            this.user = user;
                            this.updateUI();
                        });
                        
                        // Populate Inputs
                        document.getElementById('fbApiKey').value = config.apiKey;
                        document.getElementById('fbAuthDomain').value = config.authDomain;
                        document.getElementById('fbProjectId').value = config.projectId;
                        document.getElementById('fbAppId').value = config.appId;
                        
                        console.log("CloudSync Initialized");
                    }
                } catch(e) {
                    console.error("CloudSync Init Failed:", e);
                    document.getElementById('fbConnectionStatus').textContent = "ç‹€æ…‹: è¨­å®šéŒ¯èª¤";
                }
            },
            
            saveConfig: function() {
                const config = {
                    apiKey: document.getElementById('fbApiKey').value.trim(),
                    authDomain: document.getElementById('fbAuthDomain').value.trim(),
                    projectId: document.getElementById('fbProjectId').value.trim(),
                    appId: document.getElementById('fbAppId').value.trim()
                };
                
                if(config.apiKey && config.projectId) {
                    localStorage.setItem('painterApp_firebase_config', JSON.stringify(config));
                    alert("è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨é€£ç·š...");
                    window.location.reload(); // Reload to re-init firebase cleanly
                } else {
                    alert("è«‹è¼¸å…¥å¿…è¦çš„ API Key èˆ‡ Project ID");
                }
            },
            
            login: async function() {
                if(!this.isReady) return;
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(this.auth, provider);
                } catch(e) {
                    alert("ç™»å…¥å¤±æ•—: " + e.message);
                }
            },
            
            logout: async function() {
                if(!this.isReady) return;
                await signOut(this.auth);
            },
            
            updateUI: function() {
                const statusEl = document.getElementById('fbConnectionStatus');
                const loginBtn = document.getElementById('fbLoginBtn');
                const logoutBtn = document.getElementById('fbLogoutBtn');
                const actions = document.getElementById('fbSyncActions');
                
                if(this.user) {
                    statusEl.textContent = `å·²é€£ç·š: ${this.user.email}`;
                    statusEl.style.color = 'green';
                    loginBtn.style.display = 'none';
                    logoutBtn.style.display = 'block';
                    actions.style.display = 'flex';
                } else if (this.isReady) {
                    statusEl.textContent = "ç‹€æ…‹: å·²å°±ç·’ (æœªç™»å…¥)";
                    statusEl.style.color = '#FFA000';
                    loginBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                    actions.style.display = 'none';
                }
            },
            
            upload: async function(data = null) {
                if(!this.user) return;
                const payload = data || appData;
                try {
                    const docRef = doc(this.db, "users", this.user.uid);
                    await setDoc(docRef, {
                        backupData: JSON.parse(JSON.stringify(payload)), // Ensure plain object
                        updatedAt: serverTimestamp()
                    });
                    if(!data) alert("ä¸Šå‚³æˆåŠŸï¼");
                    console.log("Cloud Backup Success");
                } catch(e) {
                    console.error("Upload failed", e);
                    if(!data) alert("ä¸Šå‚³å¤±æ•—");
                }
            },
            
            autoUpload: function(data) {
                // Silent upload hook
                if(this.isReady && this.user) {
                    this.upload(data);
                }
            },
            
            download: async function() {
                if(!this.user) return;
                if(!confirm("ç¢ºå®šå¾é›²ç«¯ä¸‹è¼‰è³‡æ–™è¦†è“‹æœ¬æ©Ÿå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
                
                try {
                    const docRef = doc(this.db, "users", this.user.uid);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data().backupData;
                        if(cloudData) {
                            appData = cloudData;
                            // Re-save to local to ensure consistency
                            localStorage.setItem('painterApp_v9', JSON.stringify(appData));
                            // Re-init Logic
                            // We need to call functions from the main script. 
                            // Since initData is on window, we can call it.
                            window.initData(false); 
                            window.renderStats(); // Update stats if open
                            alert("åŒæ­¥å®Œæˆï¼");
                        }
                    } else {
                        alert("é›²ç«¯å°šç„¡å‚™ä»½è³‡æ–™");
                    }
                } catch(e) {
                    console.error("Download failed", e);
                    alert("ä¸‹è¼‰å¤±æ•—");
                }
            }
        };

        // Auto-init on load
        window.CloudSync.init();
    </script>

    <script>
        // --- 1. GLOBAL SCOPE DECLARATIONS ---
        let appData = { settings: { subItemTemplates: [], workItems: [] }, tasks: [], restDays: [], rewardCategories: [], rewardLogs: [] };
        
        window.tempSubItems = []; 
        window.tempTagIds = [];
        window.currentEditingTemplateId = null;
        window.deleteTemplateTargetId = null;
        
        // Phase 19: Navigation State
        window.settingsSourcePage = 'home';
        
        // Reward System Globals (Phase 20: Add year)
        window.rewardState = {
            mode: 'earn', // 'earn' or 'redeem'
            date: '',
            categoryId: '',
            amount: '0',
            note: '',
            editingLogId: null,
            dashboardMode: 'balance', // 'balance' or 'total'
            filterCategoryId: null,
            deletingLogId: null,
            deletingCategoryId: null,
            year: new Date().getFullYear() // Default to current year
        };

        // Phase 21: Stats System Globals
        window.statsState = {
            viewMode: 'year', // 'year' or 'month'
            currentDate: new Date(),
            isGlassHeart: false,
            activeTab: 'economy' // 'economy' or 'performance'
        };
        
        // --- PHASE 11 & 15: SETTINGS PAGE & TEMPLATE FUNCTIONS ---
        
        // Phase 19: Navigation Logic
        window.openSettings = function() {
            // Check where we are coming from
            if (document.getElementById('rewardPage').style.display !== 'none') {
                window.settingsSourcePage = 'reward';
            } else if (document.getElementById('statsPage').style.display !== 'none') {
                window.settingsSourcePage = 'stats';
            } else {
                window.settingsSourcePage = 'home';
            }

            // Close all potential active pages
            document.getElementById('rewardPage').style.display = 'none';
            document.getElementById('statsPage').style.display = 'none';
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = 'none');
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('open');
            
            // Sync current values to inputs
            document.getElementById('pgSettingDailyHours').value = appData.settings.dailyWorkHours;
            document.getElementById('pgSettingMonthlyQuota').value = appData.settings.monthlyQuota;
            
            window.renderEstList();
            window.renderTemplateList();
            
            document.getElementById('settingsPage').style.display = 'flex';
        };

        window.closeSettings = function() {
            document.getElementById('settingsPage').style.display = 'none';
            
            // Phase 19: Return to previous page
            if (window.settingsSourcePage === 'reward') {
                document.getElementById('rewardPage').style.display = 'flex';
            } else if (window.settingsSourcePage === 'stats') {
                document.getElementById('statsPage').style.display = 'flex';
            } else {
                document.querySelectorAll('.main-content-element').forEach(el => el.style.display = '');
                calculateSchedule();
            }
        };

        // Basic Settings Update
        window.updateSetting = function(key, val) {
            appData.settings[key] = parseFloat(val);
        };

        // Estimation Items CRUD
        window.renderEstList = function() {
            const container = document.getElementById('pgEstList');
            container.innerHTML = appData.settings.workItems.map((it, i) => `
                <div class="settings-item-row">
                    <input value="${it.name}" onchange="appData.settings.workItems[${i}].name=this.value" class="form-control" style="margin:0;flex:2">
                    <input type="number" id="estHours-${i}" value="${it.hours}" onchange="appData.settings.workItems[${i}].hours=parseFloat(this.value)" class="form-control" style="margin:0;flex:1">
                    <button type="button" class="icon-btn" style="color:red;" onclick="window.deleteEstItem(${i})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        };
        window.addEstItem = function() {
            appData.settings.workItems.push({name:'', hours:1});
            saveData();
            window.renderEstList();
        };
        window.deleteEstItem = function(idx) {
            appData.settings.workItems.splice(idx, 1);
            saveData();
            window.renderEstList();
        };

        // Phase 15: Template Custom Modals Logic
        window.renderTemplateList = function() {
            const container = document.getElementById('pgTemplateList');
            if(!appData.settings.subItemTemplates) appData.settings.subItemTemplates = [];

            if(appData.settings.subItemTemplates.length === 0) {
                container.innerHTML = `<div style="text-align:center; color:#AAA; padding:10px;">å°šç„¡æ¨¡æ¿</div>`;
                return;
            }
            container.innerHTML = appData.settings.subItemTemplates.map(t => `
                <div class="template-list-item">
                    <div style="flex:1; overflow:hidden; margin-right:10px;">
                        <div style="font-weight:700; color:#333;">${t.name}</div>
                        <div class="template-content-preview">${t.items.join(', ')}</div>
                    </div>
                    <div style="display:flex; gap:4px; flex-shrink:0;">
                        <button type="button" class="btn btn-secondary" style="padding:4px 8px; font-size:0.8rem;" onclick="window.openTemplateInputModal('${t.id}')">å…§å®¹</button>
                        <button type="button" class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="window.confirmDeleteTemplate('${t.id}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        };

        window.openTemplateInputModal = function(id) {
            window.currentEditingTemplateId = id ? String(id) : null;
            
            if(window.currentEditingTemplateId) {
                const t = appData.settings.subItemTemplates.find(x => String(x.id) === window.currentEditingTemplateId);
                if(t) {
                    document.getElementById('tplNameInput').value = t.name;
                    document.getElementById('tplContentInput').value = t.items.join(', ');
                }
            } else {
                document.getElementById('tplNameInput').value = '';
                document.getElementById('tplContentInput').value = '';
            }
            window.openModal('templateInputModal');
        };

        window.saveTemplateFromModal = function() {
            const name = document.getElementById('tplNameInput').value.trim();
            const content = document.getElementById('tplContentInput').value.trim();
            
            if(!name) { alert('è«‹è¼¸å…¥æ¨¡æ¿åç¨±'); return; }
            
            // Handle both English and Chinese commas
            const items = content.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s.length > 0);

            if(window.currentEditingTemplateId) {
                const t = appData.settings.subItemTemplates.find(x => String(x.id) === window.currentEditingTemplateId);
                if(t) {
                    t.name = name;
                    t.items = items;
                }
            } else {
                appData.settings.subItemTemplates.push({
                    id: Date.now().toString(),
                    name: name,
                    items: items
                });
            }
            
            saveData();
            window.renderTemplateList();
            window.closeModal('templateInputModal');
        };

        window.confirmDeleteTemplate = function(id) {
            window.deleteTemplateTargetId = String(id);
            window.openModal('templateDeleteModal');
        };

        window.executeDeleteTemplate = function() {
            if(window.deleteTemplateTargetId) {
                appData.settings.subItemTemplates = appData.settings.subItemTemplates.filter(x => String(x.id) !== window.deleteTemplateTargetId);
                saveData();
                window.renderTemplateList();
            }
            window.closeModal('templateDeleteModal');
        };

        // --- PHASE 21: STATS PAGE LOGIC ---

        window.openStatsPage = function() {
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('open');
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = 'none');
            document.getElementById('rewardPage').style.display = 'none';
            document.getElementById('statsPage').style.display = 'flex';
            window.renderStats();
        };

        window.closeStatsPage = function() {
            document.getElementById('statsPage').style.display = 'none';
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = '');
        };

        window.switchStatsTab = function(tabName) {
            window.statsState.activeTab = tabName;
            document.getElementById('tabEconomy').classList.toggle('active', tabName === 'economy');
            document.getElementById('tabPerformance').classList.toggle('active', tabName === 'performance');
            
            document.getElementById('statsContentEconomy').style.display = tabName === 'economy' ? 'block' : 'none';
            document.getElementById('statsContentPerformance').style.display = tabName === 'performance' ? 'block' : 'none';
        };

        window.toggleGlassHeart = function() {
            window.statsState.isGlassHeart = !window.statsState.isGlassHeart;
            const btn = document.getElementById('glassHeartBtn');
            btn.innerHTML = window.statsState.isGlassHeart ? 'â¤ï¸' : 'ğŸ’”';
            window.renderStats();
        };

        window.toggleStatsViewMode = function() {
            window.statsState.viewMode = window.statsState.viewMode === 'year' ? 'month' : 'year';
            window.renderStats();
        };

        window.changeStatsDate = function(delta) {
            const d = window.statsState.currentDate;
            if (window.statsState.viewMode === 'year') {
                d.setFullYear(d.getFullYear() + delta);
            } else {
                d.setMonth(d.getMonth() + delta);
            }
            window.statsState.currentDate = new Date(d); // Force update
            window.renderStats();
        };

        window.resetStatsDate = function() {
            window.statsState.currentDate = new Date();
            window.renderStats();
        };

        window.formatMoney = function(amount) {
            if (window.statsState.isGlassHeart) return 'ğŸ™ˆ';
            return 'NT$ ' + amount.toLocaleString();
        };

        window.renderStats = function() {
            const { viewMode, currentDate, isGlassHeart } = window.statsState;
            
            // 1. Update Date Display
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            document.getElementById('statsDateDisplay').textContent = viewMode === 'year' ? year : `${year} / ${month}æœˆ`;
            document.getElementById('statsViewModeDisplay').textContent = viewMode === 'year' ? 'Year View' : 'Month View';

            // 2. Filter Tasks
            // Logic: Include tasks COMPLETED within the range.
            const filteredTasks = appData.tasks.filter(t => {
                if (t.status !== 'completed' || !t.completedDate) return false;
                const d = new Date(t.completedDate);
                if (viewMode === 'year') {
                    return d.getFullYear() === year;
                } else {
                    return d.getFullYear() === year && d.getMonth() === (month - 1);
                }
            });

            // 3. Economy Stats
            const totalRevenue = filteredTasks.reduce((sum, t) => sum + (t.price || 0), 0);
            const totalHoursLogged = filteredTasks.reduce((sum, t) => sum + (t.loggedHours || 0), 0);
            const totalHoursEst = filteredTasks.reduce((sum, t) => sum + (t.estimatedHours || 0), 0);

            // Display Total Revenue
            document.getElementById('statsTotalRevenue').textContent = window.formatMoney(totalRevenue);

            // Hourly Rate Logic
            const realHourly = totalHoursLogged > 0 ? Math.round(totalRevenue / totalHoursLogged) : 0;
            const estHourly = totalHoursEst > 0 ? Math.round(totalRevenue / totalHoursEst) : 0; // Avg est rate based on tasks
            
            document.getElementById('statsRealHourly').textContent = isGlassHeart ? 'ğŸ™ˆ / hr' : `$${realHourly} / hr`;
            document.getElementById('valEstRate').textContent = isGlassHeart ? 'ğŸ™ˆ' : `$${estHourly}`;
            document.getElementById('valRealRate').textContent = isGlassHeart ? 'ğŸ™ˆ' : `$${realHourly}`;

            // Bar Charts for Rate
            const maxRate = Math.max(realHourly, estHourly) || 1;
            const barRealPct = Math.min(100, (realHourly / maxRate) * 100);
            const barEstPct = Math.min(100, (estHourly / maxRate) * 100);
            
            document.getElementById('barEstRate').style.width = `${barEstPct}%`;
            const realBarEl = document.getElementById('barRealRate');
            realBarEl.style.width = `${barRealPct}%`;
            // Red warning if real < 80% of est
            if (estHourly > 0 && realHourly < estHourly * 0.8) {
                realBarEl.style.backgroundColor = '#EF5350';
            } else {
                realBarEl.style.backgroundColor = '#42A5F5';
            }

            // Pie Chart (Revenue by Tag)
            const tagRevenue = {};
            let knownRev = 0;
            filteredTasks.forEach(t => {
                const tRev = t.price || 0;
                knownRev += tRev;
                const tagId = (t.tagIds && t.tagIds.length > 0) ? t.tagIds[0] : 'other';
                tagRevenue[tagId] = (tagRevenue[tagId] || 0) + tRev;
            });

            // If tasks have no price but we have tasks, avoid empty chart
            if (knownRev === 0 && filteredTasks.length > 0) {
                 tagRevenue['other'] = 0; // Just so keys exist
            }

            const sortedTags = Object.keys(tagRevenue).sort((a,b) => tagRevenue[b] - tagRevenue[a]);
            let conicStr = '';
            let currentDeg = 0;
            const legendContainer = document.getElementById('revenueLegend');
            legendContainer.innerHTML = '';
            
            const palette = ['#FFCDD2', '#F8BBD0', '#E1BEE7', '#D1C4E9', '#C5CAE9', '#BBDEFB', '#B3E5FC', '#B2EBF2', '#B2DFDB', '#C8E6C9'];

            sortedTags.forEach((tagId, idx) => {
                const rev = tagRevenue[tagId];
                const pct = knownRev > 0 ? (rev / knownRev) * 100 : 0;
                const deg = (pct / 100) * 360;
                const color = palette[idx % palette.length];
                
                let tagName = 'ç„¡æ¨™ç±¤';
                if(tagId !== 'other') {
                    const tagObj = appData.settings.tags.find(g => g.id == tagId);
                    if(tagObj) {
                        tagName = tagObj.name;
                    }
                }

                if (knownRev > 0) {
                    conicStr += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `;
                    currentDeg += deg;
                }

                // Legend
                if (pct > 0) {
                    legendContainer.innerHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background:${color}"></div>
                            <span>${tagName} (${Math.round(pct)}%)</span>
                        </div>
                    `;
                }
            });

            if (conicStr) conicStr = conicStr.slice(0, -2);
            else conicStr = '#F0F0F0 0deg 360deg'; // Empty state

            document.getElementById('revenuePieChart').style.background = `conic-gradient(${conicStr})`;


            // 4. Performance Stats
            document.getElementById('statsTotalHours').textContent = totalHoursLogged.toFixed(1) + 'h';
            document.getElementById('statsTotalTasks').textContent = filteredTasks.length;

            // Accuracy
            let accuracy = 0;
            if (totalHoursEst > 0) {
                accuracy = Math.round((totalHoursLogged / totalHoursEst) * 100);
            }
            const accEl = document.getElementById('statsAccuracy');
            accEl.textContent = `${accuracy}%`;
            accEl.style.color = accuracy > 110 ? '#D32F2F' : (accuracy < 90 ? '#388E3C' : '#333');

            // Top Tags Frequency
            const tagCounts = {};
            filteredTasks.forEach(t => {
                const tagId = (t.tagIds && t.tagIds.length > 0) ? t.tagIds[0] : 'other';
                if (!tagCounts[tagId]) tagCounts[tagId] = { count: 0, hours: 0 };
                tagCounts[tagId].count++;
                tagCounts[tagId].hours += (t.loggedHours || 0);
            });

            const topTags = Object.keys(tagCounts).sort((a,b) => tagCounts[b].count - tagCounts[a].count).slice(0, 5);
            const maxCount = topTags.length > 0 ? tagCounts[topTags[0]].count : 1;

            const rankContainer = document.getElementById('statsTagRank');
            rankContainer.innerHTML = topTags.map(tagId => {
                let tagName = 'ç„¡æ¨™ç±¤';
                let tagColor = '#DDD';
                if(tagId !== 'other') {
                    const tagObj = appData.settings.tags.find(g => g.id == tagId);
                    if(tagObj) {
                        tagName = tagObj.name;
                        tagColor = tagObj.color;
                    }
                }
                const data = tagCounts[tagId];
                const widthPct = (data.count / maxCount) * 100;
                
                return `
                    <div class="rank-row">
                        <div style="width:60px; font-size:0.8rem; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${tagName}</div>
                        <div class="rank-bar-bg">
                            <div class="rank-bar-fill" style="width:${widthPct}%; background:${tagColor}"></div>
                        </div>
                        <div style="font-size:0.75rem; color:#666; text-align:right;">
                            ${data.count}å¼µ<br>
                            <span style="font-size:0.7rem; color:#999;">${data.hours.toFixed(1)}h</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (topTags.length === 0) rankContainer.innerHTML = '<div style="text-align:center; color:#AAA; padding:10px;">ç„¡è³‡æ–™</div>';
        };

        // --- PHASE 16 & 17 & 18 & 20: REWARD SYSTEM LOGIC ---
        
        window.openRewardPage = function() {
            // Close sidebar
            document.querySelector('.sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').classList.remove('open');
            // Hide main content
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = 'none');
            // Show reward page
            document.getElementById('rewardPage').style.display = 'flex';
            
            window.showRewardDashboard();
        };

        window.closeRewardPage = function() {
            document.getElementById('rewardPage').style.display = 'none';
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = '');
        };

        window.showRewardDashboard = function() {
            document.querySelectorAll('.reward-sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById('rewardDashboard').classList.add('active');
            
            // Phase 17: Change Header Button to Sidebar Toggle
            const btn = document.getElementById('rewardHeaderLeftBtn');
            btn.innerHTML = '<i class="fa-solid fa-bars"></i>';
            btn.onclick = window.toggleSidebar;
            
            window.renderRewardDashboard();
        };

        window.switchRewardDashboardMode = function(mode) {
            window.rewardState.dashboardMode = mode;
            document.getElementById('segBalance').classList.toggle('active', mode === 'balance');
            document.getElementById('segTotal').classList.toggle('active', mode === 'total');
            document.getElementById('rewardStatTitle').textContent = mode === 'balance' ? 'æœªå…Œæ›çå‹µ' : 'æ­·å²ç²å–ç¸½è¨ˆ';
            window.renderRewardDashboard();
        };

        window.toggleRewardFilter = function(catId) {
            if(window.rewardState.filterCategoryId === catId) {
                window.rewardState.filterCategoryId = null;
            } else {
                window.rewardState.filterCategoryId = catId;
            }
            window.renderRewardDashboard();
        };

        window.clearRewardFilter = function() {
            window.rewardState.filterCategoryId = null;
            window.renderRewardDashboard();
        };

        // Phase 20: Year Navigation
        window.changeRewardYear = function(delta) {
            if (window.rewardState.year === 'all') {
                window.rewardState.year = new Date().getFullYear();
            } else {
                window.rewardState.year += delta;
            }
            window.renderRewardDashboard();
        };

        window.setRewardYear = function(year) {
            window.rewardState.year = year;
            window.renderRewardDashboard();
        };

        // Phase 20 Update: Add functionality to reset year on click
        window.resetRewardYear = function() {
            window.rewardState.year = new Date().getFullYear();
            window.renderRewardDashboard();
        };

        window.renderRewardDashboard = function() {
            // Phase 20 Fix: Safety check for undefined year
            if (!window.rewardState.year && window.rewardState.year !== 'all') {
                window.rewardState.year = new Date().getFullYear();
            }

            // Phase 20: Update Year Display
            const yearDisplay = document.getElementById('rewardYearDisplay');
            yearDisplay.textContent = window.rewardState.year === 'all' ? 'å…¨éƒ¨' : window.rewardState.year;

            // Phase 20: Split Logic Calculation
            const balances = {}; // All-time balance
            const totalEarnedFiltered = {}; // Filtered history total
            
            appData.rewardCategories.forEach(cat => {
                balances[cat.id] = 0;
                totalEarnedFiltered[cat.id] = 0;
            });
            
            // Iterate ALL logs for balance (MUST BE ALL-TIME)
            appData.rewardLogs.forEach(log => {
                // Balance Calculation (Rule 2.C)
                if(log.type === 'earn') balances[log.categoryId] += log.amount;
                else balances[log.categoryId] -= log.amount;

                // History Total Calculation (Rule 2.B - Filtered)
                const logYear = parseInt(log.date.split('-')[0]);
                const isYearMatch = window.rewardState.year === 'all' || logYear === window.rewardState.year;
                
                if (log.type === 'earn' && isYearMatch) {
                    totalEarnedFiltered[log.categoryId] += log.amount;
                }
            });

            // Render Stats List
            const balanceContainer = document.getElementById('rewardBalanceList');
            const mode = window.rewardState.dashboardMode;
            
            balanceContainer.innerHTML = appData.rewardCategories.map(cat => {
                // Decide which value to show based on mode
                const val = mode === 'balance' ? balances[cat.id] : totalEarnedFiltered[cat.id];
                
                // Hide zero balance/total items
                if(val <= 0) return '';
                if(cat.isArchived && mode === 'balance' && val <= 0) return ''; 

                const isActive = window.rewardState.filterCategoryId === cat.id;
                
                return `
                <div class="reward-stat-row ${isActive ? 'active' : ''}" onclick="window.toggleRewardFilter('${cat.id}')">
                    <div class="reward-stat-name">
                        <i class="fa-solid ${cat.icon}" style="color:${cat.color || '#8D6E63'}"></i> 
                        ${cat.name}
                    </div>
                    <div class="reward-stat-val">${val} <span style="font-size:0.7em; color:#999; font-weight:normal;">${cat.unit}</span></div>
                </div>
            `;
            }).join('');

            // Phase 20: Render List (Filtered & Grouped)
            const logContainer = document.getElementById('rewardLogList');
            
            // Filter logs based on category AND Year
            let displayLogs = appData.rewardLogs.filter(log => {
                // 1. Category Filter
                if (window.rewardState.filterCategoryId && log.categoryId !== window.rewardState.filterCategoryId) return false;
                
                // 2. Year Filter (Rule 2.A)
                const logYear = parseInt(log.date.split('-')[0]);
                if (window.rewardState.year !== 'all' && logYear !== window.rewardState.year) return false;
                
                return true;
            });

            // Toggle filter tag visibility
            document.getElementById('rewardLogFilterTag').style.display = window.rewardState.filterCategoryId ? 'block' : 'none';

            // Sort descending
            displayLogs.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);
            
            // Render with forced grouping
            let lastYear = null;
            
            logContainer.innerHTML = displayLogs.map(log => {
                let yearHeader = '';
                const logYear = log.date.split('-')[0];
                
                // Always group by year if year changes (Rule 3)
                if(logYear !== lastYear) {
                    lastYear = logYear;
                    yearHeader = `<div class="reward-year-header">${logYear}</div>`;
                }

                const cat = appData.rewardCategories.find(c => c.id === log.categoryId);
                const catName = cat ? cat.name : 'æœªçŸ¥é …ç›®';
                const catIcon = cat ? cat.icon : 'fa-question';
                const catColor = cat ? cat.color : '#ccc';
                const unit = cat ? cat.unit : '';
                
                const isRedeem = log.type === 'redeem';
                const sign = isRedeem ? '-' : '+';
                
                // Phase 19: Grid Layout Implementation
                return yearHeader + `
                <div class="reward-log-item ${isRedeem ? 'redeem' : ''}" onclick="window.openLogOptions(${log.id})">
                    <div class="log-grid-icon">
                        <div class="reward-log-icon">
                            <i class="fa-solid ${catIcon}" style="color:${isRedeem ? '#FFF' : catColor}"></i>
                        </div>
                    </div>
                    
                    <div class="log-grid-name">${catName}</div>
                    <div class="log-grid-date">${log.date}</div>
                    
                    <div class="log-grid-note">
                        ${log.note || ''}
                    </div>
                    
                    <div class="log-grid-amount">${sign}${log.amount} <small style="font-size:0.6em;">${unit}</small></div>
                    <div class="log-grid-type">${isRedeem ? 'å…Œæ›' : 'ç²å–'}</div>
                </div>
            `}).join('');
        };

        window.openRewardTransactionModal = function(editLogId = null) {
            // Phase 20 Fix: Preserve Year, DashboardMode, and Filter context
            const savedYear = window.rewardState.year || new Date().getFullYear();
            const savedDashMode = window.rewardState.dashboardMode || 'balance';
            const savedFilter = window.rewardState.filterCategoryId;

            if(editLogId) {
                const log = appData.rewardLogs.find(l => l.id === editLogId);
                if(!log) return;
                window.rewardState = {
                    mode: log.type,
                    date: log.date,
                    categoryId: log.categoryId,
                    amount: log.amount.toString(),
                    note: log.note || '',
                    editingLogId: editLogId,
                    // Restore context
                    year: savedYear,
                    dashboardMode: savedDashMode,
                    filterCategoryId: savedFilter
                };
            } else {
                window.rewardState = {
                    mode: 'earn',
                    date: toDateStr(new Date()),
                    categoryId: '',
                    amount: '0',
                    note: '',
                    editingLogId: null,
                    // Restore context
                    year: savedYear,
                    dashboardMode: savedDashMode,
                    filterCategoryId: savedFilter
                };
            }
            window.showRewardTransaction();
        };

        window.showRewardTransaction = function() {
            document.querySelectorAll('.reward-sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById('rewardTransaction').classList.add('active');
            
            // Phase 17: Back Button
            const btn = document.getElementById('rewardHeaderLeftBtn');
            btn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            btn.onclick = window.showRewardDashboard;

            window.updateRewardUI();
        };

        window.switchRewardTab = function(mode) {
            window.rewardState.mode = mode;
            window.updateRewardUI();
        };

        window.updateRewardUI = function() {
            const earnTab = document.getElementById('tabEarn');
            const redeemTab = document.getElementById('tabRedeem');
            const deleteBtn = document.getElementById('btnDeleteLog');
            
            if(window.rewardState.mode === 'earn') {
                earnTab.classList.add('active');
                redeemTab.classList.remove('active', 'active-redeem');
            } else {
                earnTab.classList.remove('active');
                redeemTab.classList.add('active', 'active-redeem');
            }

            document.getElementById('rewardDateBtn').textContent = window.rewardState.date;
            document.getElementById('rewardDateInput').value = window.rewardState.date;
            document.getElementById('rewardAmountDisplay').textContent = window.rewardState.amount;
            document.getElementById('rewardNote').value = window.rewardState.note;
            
            deleteBtn.style.display = window.rewardState.editingLogId ? 'block' : 'none';

            const cat = appData.rewardCategories.find(c => c.id === window.rewardState.categoryId);
            const catDisplay = document.getElementById('selectedCategoryDisplay');
            if(cat) {
                catDisplay.innerHTML = `<i class="fa-solid ${cat.icon}" style="color:${cat.color}; font-size:1.2rem;"></i> <span style="font-weight:700;">${cat.name}</span>`;
            } else {
                catDisplay.innerHTML = `<div style="color:#AAA;">é»æ“Šé¸æ“‡é¡åˆ¥...</div>`;
            }
        };

        // --- Log Options & Deletion ---
        window.openLogOptions = function(logId) {
            document.getElementById('selectedLogId').value = logId;
            window.openModal('rewardLogOptionsModal');
        };
        
        window.openDeleteLogConfirmation = function() {
            // Can be called from Options Modal or Edit Page
            window.closeModal('rewardLogOptionsModal'); // Close options first if open
            const logId = window.rewardState.editingLogId || parseInt(document.getElementById('selectedLogId').value);
            if(logId) {
                window.rewardState.deletingLogId = logId;
                window.openModal('confirmDeleteLogModal');
            }
        };

        window.executeDeleteLog = function() {
            const logId = window.rewardState.deletingLogId;
            if(logId) {
                appData.rewardLogs = appData.rewardLogs.filter(l => l.id !== logId);
                saveData();
                window.closeModal('confirmDeleteLogModal');
                // Determine where to go back
                if(document.getElementById('rewardTransaction').classList.contains('active')) {
                    window.showRewardDashboard();
                } else {
                    window.renderRewardDashboard();
                }
            }
        };

        window.editSelectedLog = function() {
            const logId = parseInt(document.getElementById('selectedLogId').value);
            window.closeModal('rewardLogOptionsModal');
            window.openRewardTransactionModal(logId);
        };

        // --- Custom Numpad Logic ---
        window.openNumpad = function() {
            document.getElementById('numpadOverlay').classList.add('active');
            document.getElementById('customNumpad').classList.add('active');
        };
        window.closeNumpad = function() {
            document.getElementById('numpadOverlay').classList.remove('active');
            document.getElementById('customNumpad').classList.remove('active');
        };
        window.numpadInput = function(val) {
            let current = window.rewardState.amount;
            if(current === '0' && val !== '.') current = '';
            if(val === '.' && current.includes('.')) return;
            current += val;
            window.rewardState.amount = current;
            document.getElementById('rewardAmountDisplay').textContent = current;
        };
        window.numpadDelete = function() {
            let current = window.rewardState.amount;
            current = current.slice(0, -1);
            if(current === '') current = '0';
            window.rewardState.amount = current;
            document.getElementById('rewardAmountDisplay').textContent = current;
        };

        // --- Category Selector & Creator ---
        window.openCategorySelector = function() {
            document.querySelectorAll('.reward-sub-page').forEach(p => p.classList.remove('active'));
            document.getElementById('rewardCategorySelect').classList.add('active');
            
            // Phase 17: Back Button behavior
            const btn = document.getElementById('rewardHeaderLeftBtn');
            btn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
            btn.onclick = window.showRewardTransaction; 

            window.renderCategoryGrids();
        };

        window.renderCategoryGrids = function() {
            const activeCats = appData.rewardCategories.filter(c => !c.isArchived);
            const archivedCats = appData.rewardCategories.filter(c => c.isArchived);

            const renderItem = (cat) => `
                <div class="category-item ${window.rewardState.categoryId === cat.id ? 'selected' : ''}" onclick="window.selectRewardCategory('${cat.id}')">
                    <div class="category-edit-btn" onclick="event.stopPropagation(); window.openEditCategoryModal('${cat.id}')"><i class="fa-solid fa-pencil"></i></div>
                    <div class="category-icon"><i class="fa-solid ${cat.icon}" style="color:${cat.color || '#8D6E63'}"></i></div>
                    <div class="category-name">${cat.name}</div>
                </div>
            `;

            document.getElementById('categoryGrid').innerHTML = activeCats.map(renderItem).join('');
            document.getElementById('archivedCategoryGrid').innerHTML = archivedCats.map(renderItem).join('');
        };

        window.toggleArchivedCategories = function() {
            const grid = document.getElementById('archivedCategoryGrid');
            const icon = document.querySelector('.archived-section-title i');
            if(grid.style.display === 'none') {
                grid.style.display = 'grid';
                icon.className = 'fa-solid fa-chevron-up';
            } else {
                grid.style.display = 'none';
                icon.className = 'fa-solid fa-chevron-down';
            }
        };

        window.selectRewardCategory = function(id) {
            window.rewardState.categoryId = id;
            window.showRewardTransaction();
        };

        // Phase 17/18: Category Edit/Create/Delete Logic
        window.openCreateCategoryModal = function() {
            window.setupCategoryModal();
            window.openModal('rewardCategoryModal');
        };

        window.openEditCategoryModal = function(id) {
            window.setupCategoryModal(id);
            window.openModal('rewardCategoryModal');
        };

        window.setupCategoryModal = function(id = null) {
            const icons = ['fa-umbrella-beach', 'fa-ice-cream', 'fa-bed', 'fa-book', 'fa-gamepad', 'fa-music', 'fa-tv', 'fa-bath', 'fa-utensils', 'fa-gift', 'fa-star', 'fa-heart', 'fa-money-bill', 'fa-ticket', 'fa-plane', 'fa-car', 'fa-bicycle', 'fa-camera', 'fa-palette', 'fa-pen-nib'];
            
            const picker = document.getElementById('iconPickerGrid');
            picker.innerHTML = icons.map(icon => `
                <div class="icon-picker-item" onclick="window.selectIcon(this, '${icon}')">
                    <i class="fa-solid ${icon}"></i>
                </div>
            `).join('');

            const deleteBtn = document.getElementById('btnDeleteCategory');

            if(id) {
                const cat = appData.rewardCategories.find(c => c.id === id);
                document.getElementById('catModalTitle').textContent = 'ç·¨è¼¯çå‹µé …ç›®';
                document.getElementById('editCatId').value = cat.id;
                document.getElementById('newCatName').value = cat.name;
                document.getElementById('newCatUnit').value = cat.unit;
                document.getElementById('newCatIcon').value = cat.icon;
                document.getElementById('newCatColor').value = cat.color || '#8D6E63';
                document.getElementById('catArchiveOption').style.display = 'block';
                document.getElementById('newCatArchived').checked = !!cat.isArchived;
                deleteBtn.style.display = 'block';
                
                // Select icon visually
                setTimeout(() => {
                    const el = Array.from(document.querySelectorAll('.icon-picker-item')).find(el => el.innerHTML.includes(cat.icon));
                    if(el) el.classList.add('selected');
                }, 50);

            } else {
                document.getElementById('catModalTitle').textContent = 'æ–°å¢çå‹µé …ç›®';
                document.getElementById('editCatId').value = '';
                document.getElementById('newCatName').value = '';
                document.getElementById('newCatUnit').value = '';
                document.getElementById('newCatIcon').value = '';
                document.getElementById('newCatColor').value = '#8D6E63';
                document.getElementById('catArchiveOption').style.display = 'none';
                document.getElementById('newCatArchived').checked = false;
                deleteBtn.style.display = 'none';
            }
        };

        window.selectIcon = function(el, iconClass) {
            document.querySelectorAll('.icon-picker-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('newCatIcon').value = iconClass;
        };

        window.saveCategory = function() {
            const id = document.getElementById('editCatId').value;
            const name = document.getElementById('newCatName').value;
            const unit = document.getElementById('newCatUnit').value;
            const icon = document.getElementById('newCatIcon').value;
            const color = document.getElementById('newCatColor').value;
            const isArchived = document.getElementById('newCatArchived').checked;
            
            if(name && unit && icon) {
                if(id) {
                    const cat = appData.rewardCategories.find(c => c.id === id);
                    if(cat) {
                        cat.name = name; cat.unit = unit; cat.icon = icon; cat.color = color; cat.isArchived = isArchived;
                    }
                } else {
                    appData.rewardCategories.push({
                        id: Date.now().toString(),
                        name, unit, icon, color,
                        isArchived: false
                    });
                }
                saveData();
                window.closeModal('rewardCategoryModal');
                window.renderCategoryGrids();
            } else {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦é¸æ“‡åœ–ç¤º');
            }
        };

        window.openDeleteCategoryConfirmation = function() {
            const id = document.getElementById('editCatId').value;
            if(id) {
                window.rewardState.deletingCategoryId = id;
                window.closeModal('rewardCategoryModal');
                window.openModal('confirmDeleteCategoryModal');
            }
        };

        window.executeDeleteCategory = function() {
            const id = window.rewardState.deletingCategoryId;
            if(id) {
                appData.rewardCategories = appData.rewardCategories.filter(c => c.id !== id);
                saveData();
                window.closeModal('confirmDeleteCategoryModal');
                window.renderCategoryGrids();
            }
        };

        // --- Date Picker Logic ---
        window.openRewardDateModal = function() {
            document.getElementById('rewardDatePicker').value = window.rewardState.date;
            window.openModal('rewardDateModal');
        };
        window.confirmRewardDate = function() {
            const val = document.getElementById('rewardDatePicker').value;
            if(val) {
                window.rewardState.date = val;
                window.updateRewardUI();
            }
            window.closeModal('rewardDateModal');
        };

        // --- Transaction Submission ---
        window.submitRewardTransaction = function() {
            const amount = parseFloat(window.rewardState.amount);
            const catId = window.rewardState.categoryId;
            const note = document.getElementById('rewardNote').value;
            
            if(!catId || amount <= 0) {
                alert('è«‹é¸æ“‡é¡åˆ¥ä¸¦è¼¸å…¥æ•¸é‡'); return;
            }

            if(window.rewardState.mode === 'redeem') {
                // Check balance
                let balance = 0;
                appData.rewardLogs.forEach(log => {
                    // Exclude current log if editing
                    if(window.rewardState.editingLogId && log.id === window.rewardState.editingLogId) return;
                    
                    if(log.categoryId === catId) {
                        balance += (log.type === 'earn' ? log.amount : -log.amount);
                    }
                });
                
                if(balance < amount) {
                    window.openModal('insufficientFundsModal');
                    return;
                }
            }
            
            window.finalizeRewardTransaction(amount, catId, note);
        };

        window.forceSubmitReward = function() {
            const amount = parseFloat(window.rewardState.amount);
            const catId = window.rewardState.categoryId;
            const note = document.getElementById('rewardNote').value;
            window.closeModal('insufficientFundsModal');
            window.finalizeRewardTransaction(amount, catId, note);
        };

        window.finalizeRewardTransaction = function(amount, catId, note) {
            if(window.rewardState.editingLogId) {
                // Edit existing
                const log = appData.rewardLogs.find(l => l.id === window.rewardState.editingLogId);
                if(log) {
                    log.date = window.rewardState.date;
                    log.categoryId = catId;
                    log.type = window.rewardState.mode;
                    log.amount = amount;
                    log.note = note;
                }
            } else {
                // Create new
                appData.rewardLogs.push({
                    id: Date.now(),
                    date: window.rewardState.date,
                    categoryId: catId,
                    type: window.rewardState.mode,
                    amount: amount,
                    note: note
                });
                // Animation for new items only
                if(window.rewardState.mode === 'redeem') {
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#5D4037', '#D7CCC8'] });
                } else {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            }
            saveData();
            window.showRewardDashboard();
        };

        // --- 2. SUB-TASK TEMPLATE FUNCTIONS (Phase 9.9 Refactor) ---
        
        window.openSubTaskEditModal = function() {
            window.renderSubTaskEditView();
            document.getElementById('subItemEditModal').classList.add('active');
        };

        window.closeSubItemEditModal = function() {
            document.getElementById('subItemEditModal').classList.remove('active');
            window.renderSubItemView(); 
        };

        window.renderSubTaskEditView = function() {
            const body = document.getElementById('subItemEditModalBody');
            
            let options = '<option value="">-- é¸æ“‡æ¨¡æ¿ --</option>';
            if(appData.settings.subItemTemplates && appData.settings.subItemTemplates.length > 0) {
                options += appData.settings.subItemTemplates.map(t => 
                    `<option value="${t.id}">${t.name} (${t.items.length}é …)</option>`
                ).join('');
            }

            let listHtml = '';
            if(window.tempSubItems.length === 0) {
                listHtml = '<div style="text-align:center; color:#AAA; font-size:0.8rem; padding:10px;">ç„¡å­é …ç›®</div>';
            } else {
                listHtml = window.tempSubItems.map((item, idx) => `
                    <div class="sub-task-item">
                        <div style="display:flex; flex-direction:column; gap:2px;">
                           <button type="button" class="btn-icon-xs" onclick="window.moveSubTaskItem(${idx}, -1)"><i class="fa-solid fa-chevron-up"></i></button>
                           <button type="button" class="btn-icon-xs" onclick="window.moveSubTaskItem(${idx}, 1)"><i class="fa-solid fa-chevron-down"></i></button>
                        </div>
                        <div class="sub-task-item-content">
                            <input class="sub-task-item-input" value="${item.text}" onchange="window.updateSubTaskItem(${idx}, this.value)">
                        </div>
                        <button type="button" class="btn-icon-xs" onclick="window.removeSubTaskItem(${idx})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('');
            }

            body.innerHTML = `
                <div style="display:flex; gap:8px; margin-bottom:5px; align-items:center; background:#F5F5F5; padding:8px; border-radius:8px;">
                    <select id="subTaskTemplateSelect" class="form-control" style="margin:0; flex:1; font-size:0.9rem;">
                        ${options}
                    </select>
                    <button type="button" class="btn btn-success" style="padding:8px 12px; font-size:0.9rem;" onclick="window.applySubTaskTemplate()">
                        å¥—ç”¨
                    </button>
                </div>
                <div style="text-align:right; margin-bottom:10px;">
                    <span style="font-size:0.8rem; color:var(--primary-color); cursor:pointer;" onclick="window.jumpToTemplateSettings()">ç®¡ç†æ¨¡æ¿è¨­å®š &rarr;</span>
                </div>
                
                <div style="flex:1; overflow-y:auto; margin-bottom:12px;">${listHtml}</div>
                
                <button type="button" class="btn btn-secondary" style="width:100%; padding:10px; margin-bottom:10px;" onclick="window.addSubTaskItem()">
                    <i class="fa-solid fa-plus"></i> æ–°å¢å­é …ç›®
                </button>
                <button type="button" class="btn btn-primary" style="width:100%; padding:10px;" onclick="window.closeSubItemEditModal()">
                    ç¢ºå®š
                </button>
            `;
        };

        window.applySubTaskTemplate = function() {
            const select = document.getElementById('subTaskTemplateSelect');
            const id = select.value;
            if(!id) return;

            const tpl = appData.settings.subItemTemplates.find(t => String(t.id) === String(id));
            if(tpl) {
                const newItems = tpl.items.map(txt => ({
                    id: Date.now() + Math.random(),
                    text: txt,
                    done: false,
                    loggedAtCheck: ''
                }));
                window.tempSubItems = [...window.tempSubItems, ...newItems];
                window.renderSubTaskEditView();
            }
        };

        window.jumpToTemplateSettings = function() {
            window.closeSubItemEditModal();
            window.closeModal('addTaskModal'); 
            window.openSettings();
        };

        window.addSubTaskItem = function() {
            window.tempSubItems.push({ id: Date.now(), text: '', done: false, loggedAtCheck: '' });
            window.renderSubTaskEditView();
        };

        window.removeSubTaskItem = function(idx) {
            window.tempSubItems.splice(idx, 1);
            window.renderSubTaskEditView();
        };

        window.updateSubTaskItem = function(idx, val) {
            window.tempSubItems[idx].text = val;
        };

        window.moveSubTaskItem = function(idx, dir) {
            if(idx + dir < 0 || idx + dir >= window.tempSubItems.length) return;
            const temp = window.tempSubItems[idx];
            window.tempSubItems[idx] = window.tempSubItems[idx+dir];
            window.tempSubItems[idx+dir] = temp;
            window.renderSubTaskEditView();
        };

        // --- 3. NORMAL APP LOGIC ---
        const DEFAULT_SETTINGS = {
            dailyWorkHours: 8,
            monthlyQuota: 4,
            workItems: [
                { name: "é ­åƒ", hours: 4 }, { name: "åŠèº«", hours: 6 },
                { name: "å…¨èº«", hours: 12 }, { name: "èƒŒæ™¯", hours: 4 }
            ],
            tags: [ { id: 1, name: "æ€¥ä»¶", color: "#FFEBEE" }, { id: 2, name: "ä¸€èˆ¬", color: "#E3F2FD" } ],
            subItemTemplates: [
                { id: "999", name: "ä¸€èˆ¬æ’ç•«", items: ["è‰ç¨¿", "ç·šç¨¿", "åº•è‰²", "å®Œç¨¿"] }
            ]
        };

        function getNoonDate(dateInput) {
            const d = new Date(dateInput);
            d.setHours(12, 0, 0, 0);
            return d;
        }
        function toDateStr(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }

        const TODAY_STR = toDateStr(getNoonDate(new Date()));
        let currentViewDate = getNoonDate(new Date()); 
        let currentTaskIndex = 0; 
        window.selectedTaskId = null;
        let deleteTargetId = null;
        let completingTaskId = null;

        function addDays(dateStr, days) {
            const d = getNoonDate(dateStr);
            d.setDate(d.getDate() + days);
            return toDateStr(d);
        }
        function getDatesInRange(startDate, endDate) {
            const dates = []; 
            let current = getNoonDate(startDate); 
            const end = getNoonDate(endDate);
            while (current <= end) { 
                dates.push(toDateStr(current)); 
                current.setDate(current.getDate() + 1); 
            }
            return dates;
        }

        function getDayCapacity(dateStr) {
            const rest = appData.restDays.find(r => r.date === dateStr);
            let capacity = appData.settings.dailyWorkHours;
            if (rest) {
                if (rest.isFullDay) {
                    capacity = 0;
                } else if (rest.start && rest.end) {
                    const s = parseInt(rest.start.split(':')[0]) + parseInt(rest.start.split(':')[1])/60;
                    const e = parseInt(rest.end.split(':')[0]) + parseInt(rest.end.split(':')[1])/60;
                    const diff = Math.max(0, e - s);
                    capacity = Math.max(0, capacity - diff);
                }
            }
            return capacity;
        }

        function calculateSchedule() {
            const mapStart = TODAY_STR; 
            const mapEnd = addDays(mapStart, 120);
            const range = getDatesInRange(mapStart, mapEnd);
            
            const dateMap = {};
            range.forEach(date => { dateMap[date] = getDayCapacity(date); });

            const fixedTasks = appData.tasks.filter(t => (t.status === 'active' && t.locked) || t.status === 'completed');
            fixedTasks.forEach(task => {
                if(task.status === 'completed' && task.computedStartDate) return; 

                let hoursNeeded = task.estimatedHours - (task.loggedHours || 0);
                if(hoursNeeded <= 0) return;
                
                let currentDay = task.manualStartDate || TODAY_STR; 
                task.computedStartDate = currentDay;
                
                while(hoursNeeded > 0) {
                    if (dateMap[currentDay] !== undefined) {
                        const cap = dateMap[currentDay];
                        const consume = Math.min(appData.settings.dailyWorkHours, hoursNeeded); 
                        dateMap[currentDay] = Math.max(0, cap - consume);
                        hoursNeeded -= consume;
                    }
                    if(hoursNeeded > 0) currentDay = addDays(currentDay, 1);
                }
                task.computedEndDate = currentDay;
            });

            const floatingTasks = appData.tasks
                .filter(t => t.status === 'active' && !t.locked)
                .sort((a, b) => a.priorityOrder - b.priorityOrder);

            floatingTasks.forEach(task => {
                let hoursNeeded = task.estimatedHours - (task.loggedHours || 0);
                if (hoursNeeded <= 0) return;
                let startFound = false;
                let currentDayIdx = 0;
                while(currentDayIdx < range.length) {
                    const d = range[currentDayIdx];
                    const cap = dateMap[d];
                    if (cap > 0) {
                        if (!startFound) { task.computedStartDate = d; startFound = true; }
                        const work = Math.min(cap, hoursNeeded);
                        dateMap[d] -= work;
                        hoursNeeded -= work;
                        if (hoursNeeded <= 0.01) { 
                            task.computedEndDate = d; break; 
                        }
                    }
                    currentDayIdx++;
                }
            });

            saveData();
            renderCalendar();
            renderCurrentTask();
        }

        window.initData = function(reset = false) {
            const saved = localStorage.getItem('painterApp_v9');
            if (saved && !reset) {
                appData = JSON.parse(saved);
                if(!appData.settings.subItemTemplates) appData.settings.subItemTemplates = DEFAULT_SETTINGS.subItemTemplates;
                if(!appData.rewardCategories) appData.rewardCategories = [];
                if(!appData.rewardLogs) appData.rewardLogs = [];
            } else {
                appData.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
                appData.tasks = [
                    { id: 't1', title: 'ç¤ºä¾‹ä»»å‹™', tagIds: [2], estimatedHours: 10, loggedHours: 0, status: 'active', priorityOrder: 1, selectedItemIndices: [] }
                ];
                appData.restDays = [];
                appData.rewardCategories = [];
                appData.rewardLogs = [];
                calculateSchedule();
            }
            
            // Init Default Rewards if empty
            if(appData.rewardCategories.length === 0) {
                appData.rewardCategories = [
                    { id: '1', name: 'ä¼‘å‡', unit: 'å¤©', icon: 'fa-umbrella-beach', color: '#f0f4c3' },
                    { id: '2', name: 'ç”œé»', unit: 'æ¨£', icon: 'fa-ice-cream', color: '#f8bbd0' },
                    { id: '3', name: 'ä¼‘æ¯', unit: 'å°æ™‚', icon: 'fa-bed', color: '#e1bee7' }
                ];
                saveData();
            }

            window.renderSidebar();
            renderCalendar();
            renderCurrentTask();
        };
        
        function saveData() { 
            localStorage.setItem('painterApp_v9', JSON.stringify(appData));
            // Hook for CloudSync
            if(window.CloudSync && typeof window.CloudSync.autoUpload === 'function') {
                window.CloudSync.autoUpload(appData);
            }
        }

        // --- Rendering ---
        
        function renderCalendar() {
            const container = document.getElementById('calendarRows');
            container.innerHTML = '';
            
            const y = currentViewDate.getFullYear();
            const m = currentViewDate.getMonth();
            document.getElementById('headerMonthTitle').textContent = `${y}å¹´ ${m+1}æœˆ`;

            const firstDayOfMonth = new Date(y, m, 1);
            const startDay = firstDayOfMonth.getDay() || 7; 
            const startDate = getNoonDate(firstDayOfMonth);
            startDate.setDate(1 - (startDay - 1)); 

            const weeksToRender = 5; 
            
            for(let w=0; w<weeksToRender; w++) {
                const rowStart = new Date(startDate);
                rowStart.setDate(startDate.getDate() + (w * 7));
                const rowEnd = new Date(rowStart);
                rowEnd.setDate(rowStart.getDate() + 6);

                const sStr = toDateStr(rowStart);
                const eStr = toDateStr(rowEnd);
                
                const row = document.createElement('div');
                row.className = 'calendar-week-row';
                
                const gridLayer = document.createElement('div');
                gridLayer.className = 'week-grid-layer';
                
                const dates = getDatesInRange(sStr, eStr);
                dates.forEach(dateStr => {
                    const dObj = getNoonDate(dateStr);
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.setAttribute('data-date', dateStr);
                    
                    if (dObj.getMonth() !== m) cell.classList.add('not-current-month');
                    
                    const rest = appData.restDays.find(r => r.date === dateStr);
                    if (rest) {
                        cell.classList.add('rest-day');
                        cell.onclick = () => window.openRestModal(dateStr); 
                    }

                    cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
                    cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                    cell.addEventListener('drop', handleCalendarDrop);

                    let dayNumClass = 'day-number';
                    if(dateStr === TODAY_STR) dayNumClass += ' today-circle';

                    let html = `<div class="${dayNumClass}">${dObj.getDate()}</div>`;
                    
                    const dls = appData.tasks.filter(t => t.deadline === dateStr);
                    if(dls.length > 0) {
                        const countBadge = dls.length > 1 ? `<span class="deadline-count">${dls.length}</span>` : '';
                        html += `<div class="deadline-flag" onclick="window.toggleDeadlinePopover(event, '${dateStr}', ${dObj.getDay()})">
                                    <i class="fa-solid fa-flag"></i> ${countBadge}
                                 </div>`;
                    }
                    
                    cell.innerHTML = html;
                    gridLayer.appendChild(cell);
                });
                row.appendChild(gridLayer);

                const taskLayer = document.createElement('div');
                taskLayer.className = 'week-task-layer';
                
                const visibleTasks = appData.tasks.filter(t => 
                    (t.status === 'active' || t.status === 'completed' || t.status === 'paused') &&
                    t.computedStartDate && 
                    t.computedStartDate <= eStr && 
                    (t.computedEndDate || t.computedStartDate) >= sStr
                );

                const rowAllocations = [];
                visibleTasks.forEach(task => {
                    let startIdx = 0; let endIdx = 6;
                    if(task.computedStartDate >= sStr) startIdx = Math.floor((getNoonDate(task.computedStartDate) - rowStart)/86400000);
                    const endDate = task.computedEndDate || task.computedStartDate;
                    if(endDate <= eStr) endIdx = Math.floor((getNoonDate(endDate) - rowStart)/86400000);
                    
                    startIdx = Math.max(0, startIdx);
                    endIdx = Math.min(6, endIdx);

                    let vRow = 0;
                    while(true) {
                        let col = false;
                        for(let i=startIdx; i<=endIdx; i++) {
                            if(rowAllocations[vRow] && rowAllocations[vRow][i]) { col=true; break; }
                        }
                        if(!col) break;
                        vRow++;
                    }
                    if(!rowAllocations[vRow]) rowAllocations[vRow]={};
                    for(let i=startIdx; i<=endIdx; i++) rowAllocations[vRow][i]=true;

                    const ids = task.tagIds && task.tagIds.length > 0 ? task.tagIds : [];
                    const tag = appData.settings.tags.find(g => ids.includes(g.id));

                    const bar = document.createElement('div');
                    bar.className = 'abs-task-bar';
                    if(task.status === 'completed') bar.classList.add('completed');
                    
                    if(task.status === 'paused') {
                        bar.classList.add('paused');
                        bar.innerHTML = `<i class="fa-solid fa-pause" style="font-size:0.6rem; margin-right:4px;"></i>${task.title}`;
                    } else {
                        bar.textContent = task.title;
                        if(task.locked) bar.innerHTML = `<i class="fa-solid fa-lock" style="font-size:0.6rem; margin-right:4px;"></i>` + bar.textContent;
                    }
                    
                    bar.style.backgroundColor = tag ? tag.color : '#eee';
                    bar.style.color = (tag && tag.id==1) ? 'var(--tag-text-urgent)' : 'var(--tag-text-normal)';
                    bar.style.left = `calc(${(startIdx/7)*100}% + 2px)`;
                    bar.style.width = `calc(${((endIdx-startIdx+1)/7)*100}% - 4px)`;
                    bar.style.top = `${vRow * 24}px`;
                    
                    bar.draggable = true;
                    bar.addEventListener('dragstart', (e) => { e.dataTransfer.setData('id', task.id); });
                    bar.addEventListener('click', (e) => { e.stopPropagation(); openBottomSheet(task); });
                    
                    initTouchDrag(bar, task);

                    taskLayer.appendChild(bar);
                });
                row.appendChild(taskLayer);
                container.appendChild(row);
            }
        }

        // --- GEOMETRIC TOUCH DRAG ---
        function initTouchDrag(element, task) {
            let ghost = null;
            let isDragging = false;
            let startX = 0;
            let startY = 0;
            
            element.addEventListener('touchstart', (e) => {
                if(e.touches.length > 1) return;
                const t = e.touches[0];
                startX = t.clientX;
                startY = t.clientY;
                isDragging = false;
            }, {passive:true});

            element.addEventListener('touchmove', (e) => {
                const t = e.touches[0];
                const moveX = t.clientX - startX;
                const moveY = t.clientY - startY;
                const dist = Math.sqrt(moveX*moveX + moveY*moveY);

                if (!isDragging && dist > 15) {
                    isDragging = true;
                    ghost = element.cloneNode(true);
                    ghost.className = 'drag-ghost';
                    ghost.style.width = element.offsetWidth + 'px';
                    ghost.style.zIndex = '9999';
                    document.body.appendChild(ghost);
                    element.classList.add('active-touch');
                }

                if(isDragging) {
                    e.preventDefault(); 
                    ghost.style.left = (t.clientX - 10) + 'px';
                    ghost.style.top = (t.clientY - 10) + 'px';
                    
                    document.querySelectorAll('.day-cell.drag-highlight').forEach(c => c.classList.remove('drag-highlight'));
                    let target = getCellByCoord(t.clientX, t.clientY);
                    if(target) target.classList.add('drag-highlight');
                }
            }, {passive:false});

            element.addEventListener('touchend', (e) => {
                if(!isDragging) return;
                
                isDragging = false;
                if(ghost) ghost.remove();
                element.classList.remove('active-touch');
                
                let t = e.changedTouches[0];
                let target = getCellByCoord(t.clientX, t.clientY);
                document.querySelectorAll('.day-cell.drag-highlight').forEach(c => c.classList.remove('drag-highlight'));

                if(target) {
                    let date = target.getAttribute('data-date');
                    task.manualStartDate = date;
                    task.locked = true;
                    task.status = 'active';
                    calculateSchedule();
                }
            });
        }

        function getCellByCoord(x, y) {
            let cells = document.querySelectorAll('.day-cell');
            for(let cell of cells) {
                let rect = cell.getBoundingClientRect();
                if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return cell;
                }
            }
            return null;
        }

        function initSidebarTouchSort(element, index) {
            let ghost = null;
            let startX = 0;
            let startY = 0;
            let isDragging = false;

            element.addEventListener('touchstart', (e) => {
                if(e.touches.length > 1) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = false;
            }, {passive: true});

            element.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const moveX = touch.clientX - startX;
                const moveY = touch.clientY - startY;
                const dist = Math.sqrt(moveX*moveX + moveY*moveY);

                if (!isDragging && dist > 15) {
                    isDragging = true;
                    ghost = element.cloneNode(true);
                    ghost.classList.add('drag-ghost');
                    ghost.style.width = element.getBoundingClientRect().width + 'px';
                    ghost.style.background = '#FFF';
                    document.body.appendChild(ghost);
                    element.style.opacity = '0.3';
                }

                if(isDragging) {
                    e.preventDefault();
                    if(ghost) {
                        ghost.style.top = (touch.clientY - 20) + 'px';
                        ghost.style.left = (touch.clientX - 20) + 'px';
                        
                        ghost.style.display = 'none';
                        const target = document.elementFromPoint(touch.clientX, touch.clientY);
                        ghost.style.display = 'block';
                        
                        document.querySelectorAll('.sortable-item').forEach(el => el.classList.remove('drag-over-target'));
                        const targetItem = target?.closest('.sortable-item');
                        if(targetItem && targetItem !== element) {
                            targetItem.classList.add('drag-over-target');
                        }
                    }
                }
            }, {passive: false});

            element.addEventListener('touchend', (e) => {
                 if (isDragging) {
                    const touch = e.changedTouches[0];
                    if(ghost) ghost.remove();
                    element.style.opacity = '1';
                    if(ghost) ghost.style.display = 'none';
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    const targetItem = target?.closest('.sortable-item');
                    if(targetItem && targetItem !== element) {
                        let currentList = appData.tasks.filter(t => t.status==='active' && !t.locked).sort((a,b)=>a.priorityOrder-b.priorityOrder);
                        const fromId = element.getAttribute('data-id');
                        const toId = targetItem.getAttribute('data-id');
                        const fromIdx = currentList.findIndex(t => t.id === fromId);
                        const toIdx = currentList.findIndex(t => t.id === toId);
                        if(fromIdx !== -1 && toIdx !== -1) {
                             const moved = currentList.splice(fromIdx, 1)[0];
                             currentList.splice(toIdx, 0, moved);
                             currentList.forEach((t, i) => t.priorityOrder = i);
                             calculateSchedule(); window.renderSidebar();
                        }
                    }
                    document.querySelectorAll('.sortable-item').forEach(el => el.classList.remove('drag-over-target'));
                    isDragging = false;
                    ghost = null;
                 }
            });
        }

        window.toggleDeadlinePopover = function(e, dateStr, dayIndex) {
            e.stopPropagation();
            document.querySelectorAll('.deadline-popover').forEach(p => p.remove());
            const dls = appData.tasks.filter(t => t.deadline === dateStr);
            if(dls.length === 0) return;
            const popover = document.createElement('div');
            popover.className = 'deadline-popover';
            if(dayIndex === 0 || dayIndex === 5 || dayIndex === 6) popover.classList.add('pop-left');
            popover.innerHTML = `<div style="font-weight:700; border-bottom:1px solid #eee; margin-bottom:5px; padding-bottom:5px;">${dateStr} æ­»ç·š</div>` + 
                dls.map(t => `<div style="font-size:0.9rem; margin-bottom:4px;">â€¢ ${t.title}</div>`).join('');
            const rect = e.currentTarget.getBoundingClientRect();
            popover.style.top = (rect.bottom + 5) + 'px';
            if (!popover.classList.contains('pop-left')) popover.style.left = rect.left + 'px';
            document.body.appendChild(popover);
            const closeFn = () => { popover.remove(); document.removeEventListener('click', closeFn); };
            setTimeout(() => document.addEventListener('click', closeFn), 0);
        };

        window.changeMonth = function(delta) {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            renderCalendar();
        };
        window.resetToToday = function() {
            currentViewDate = getNoonDate(new Date());
            renderCalendar();
        };
        function handleCalendarDrop(e) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over');
            const id = e.dataTransfer.getData('id');
            const date = e.currentTarget.getAttribute('data-date');
            const t = appData.tasks.find(x => x.id === id);
            if(t && date) {
                t.manualStartDate = date; t.locked = true; t.status = 'active';
                calculateSchedule();
            }
        }

        function renderCurrentTask() {
            const container = document.getElementById('taskCarousel');
            const tasks = appData.tasks.filter(t => {
                if(t.status !== 'active') return false;
                const inRange = t.computedStartDate && t.computedStartDate <= TODAY_STR && (t.computedEndDate||t.computedStartDate) >= TODAY_STR;
                return inRange || t.loggedHours > 0;
            }).sort((a,b) => new Date(a.computedStartDate) - new Date(b.computedStartDate));

            if(tasks.length === 0) {
                container.innerHTML = `<div class="task-card" style="justify-content:center; color: var(--light-text);">ç„¡é€²è¡Œä¸­ä»»å‹™</div>`;
                return;
            }

            if(currentTaskIndex >= tasks.length) currentTaskIndex = 0;
            if(currentTaskIndex < 0) currentTaskIndex = tasks.length - 1;

            const task = tasks[currentTaskIndex];
            if (!task) { currentTaskIndex = 0; renderCurrentTask(); return; }

            const taskTagIds = task.tagIds || [];
            const tagsHtml = taskTagIds.map(id => {
                const tag = appData.settings.tags.find(g => g.id == id);
                if(tag) return `<div class="tag-pill-small" style="background:${tag.color}">${tag.name}</div>`;
                return '';
            }).join('');

            const remaining = Math.max(0, task.estimatedHours - (task.loggedHours || 0));

            let html = `
                <div class="task-card" onclick="openBottomSheetFromId('${task.id}')">
                    <div class="task-info">
                        <div class="card-tags">${tagsHtml || '<small style="color:#AAA">ç„¡æ¨™ç±¤</small>'}</div>
                        <h2>${task.title}</h2>
                        <div style="font-size:0.85rem; color:var(--light-text);">å‰©é¤˜ ${remaining} å°æ™‚</div>
                    </div>
            `;
            if(tasks.length > 1) {
                html += `<i class="fa-solid fa-chevron-right carousel-arrow" onclick="event.stopPropagation(); window.changeCurrentTask(1)"></i>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }
        window.changeCurrentTask = function(delta) {
            currentTaskIndex += delta;
            renderCurrentTask();
        };

        const sheet = document.getElementById('bottomSheet');
        const handle = document.getElementById('sheetHandle');
        let sheetStartY = 0;

        handle.addEventListener('touchstart', e => { sheetStartY = e.touches[0].clientY; });
        handle.addEventListener('touchmove', e => {
            const deltaY = e.touches[0].clientY - sheetStartY;
            if (deltaY < -30) sheet.classList.add('expanded');
            if (deltaY > 50) sheet.classList.remove('expanded');
        });

        window.openBottomSheet = function(task) {
            window.selectedTaskId = task.id;
            document.getElementById('sheetTaskTitle').textContent = task.title;
            document.getElementById('sheetLoggedTime').textContent = (task.loggedHours || 0) + 'h';
            
            const subItemsContainer = document.getElementById('sheetSubItemsContainer');
            subItemsContainer.innerHTML = '';
            sheet.classList.remove('has-subitems', 'expanded');

            if(task.subItems && task.subItems.length > 0) {
                sheet.classList.add('has-subitems');
                const incomplete = task.subItems.filter(item => !item.done);
                if(incomplete.length > 0) {
                    const constToShow = incomplete.slice(0, 4);
                    subItemsContainer.innerHTML = `<div style="font-size:0.75rem; color:#888; font-weight:700; margin-bottom:4px;">å¾…è¾¦å­é …ç›®</div>` + 
                        constToShow.map((item) => {
                             const originalIdx = task.subItems.indexOf(item);
                             return `
                            <div class="sheet-sub-item-row" onclick="checkSubItemInSheet('${task.id}', ${originalIdx})">
                                <div class="sheet-checkbox"></div>
                                <span>${item.text}</span>
                            </div>
                        `}).join('');
                }
            }

            let btnHtml = '';
            let btnClass = '';
            if(task.status === 'completed') {
                btnHtml = '<i class="fa-solid fa-rotate-left"></i> å¾©åŸ';
                btnClass = 'btn btn-warning btn-action-complete';
            } else {
                btnHtml = '<i class="fa-solid fa-check"></i> å®Œæˆ';
                btnClass = 'btn btn-success btn-action-complete';
            }
            
            const actions = document.getElementById('sheetActionsContainer');
            actions.innerHTML = `
                <button type="button" class="${btnClass}" onclick="completeTaskAction('${task.id}')">
                    ${btnHtml}
                </button>
                 <button type="button" class="btn btn-secondary btn-action-edit" onclick="editTaskAction('${task.id}')">
                    <i class="fa-solid fa-pen"></i> ç·¨è¼¯
                </button>
                <button type="button" class="btn btn-secondary btn-action-pause" onclick="togglePauseAction('${task.id}')">
                    <i class="fa-solid fa-pause"></i> æš«åœ
                </button>
                <button type="button" class="btn btn-secondary btn-action-lock" onclick="toggleLockAction('${task.id}')">
                    <i class="fa-solid fa-lock"></i> é–å®š
                </button>
                <button type="button" class="btn btn-danger btn-action-delete" onclick="deleteTaskAction('${task.id}')">
                    <i class="fa-solid fa-trash"></i> åˆªé™¤
                </button>
            `;

            sheet.classList.add('active');
            document.getElementById('sheetOverlay').classList.add('active');
        };
        window.openBottomSheetFromId = function(id) {
            const t = appData.tasks.find(x => x.id === id);
            if(t) window.openBottomSheet(t);
        };
        window.closeBottomSheet = function() {
            sheet.classList.remove('active', 'expanded', 'has-subitems');
            document.getElementById('sheetOverlay').classList.remove('active');
            window.selectedTaskId = null;
        };

        window.adjustLog = function(amount) {
            if(!window.selectedTaskId) return;
            const t = appData.tasks.find(x => x.id === window.selectedTaskId);
            if(t) {
                t.loggedHours = Math.max(0, (t.loggedHours || 0) + amount);
                document.getElementById('sheetLoggedTime').textContent = t.loggedHours + 'h';
                calculateSchedule();
            }
        };
        
        window.checkSubItemInSheet = function(taskId, idx) {
            const t = appData.tasks.find(x => x.id === taskId);
            if(t && t.subItems && t.subItems[idx]) {
                t.subItems[idx].done = true;
                const currentLog = t.loggedHours || 0;
                const lastLog = t.lastCheckpointHours || 0;
                const diff = currentLog - lastLog;
                t.subItems[idx].loggedAtCheck = `(${diff.toFixed(1)}h)`;
                t.lastCheckpointHours = currentLog;
                saveData();
                openBottomSheet(t);
            }
        };

        window.completeTaskAction = function(id) {
            const t = appData.tasks.find(x => x.id === id);
            if(t) {
                if(t.status === 'completed') {
                    t.status = 'active';
                    t.completedDate = null;
                    calculateSchedule(); window.closeBottomSheet();
                } else {
                    completingTaskId = id;
                    window.closeBottomSheet();
                    const est = t.estimatedHours || 0;
                    const log = t.loggedHours || 0;
                    const diff = est - log;
                    const msg = diff >= 0 ? `æ¯”é æœŸæ—© ${diff.toFixed(1)} å°æ™‚` : `æ¯”é æœŸæ™š ${Math.abs(diff).toFixed(1)} å°æ™‚`;
                    document.getElementById('celebrationStat').textContent = msg;
                    document.getElementById('completionOverlay').classList.add('active');
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            }
        };

        window.closeCompletionOverlay = function() {
            document.getElementById('completionOverlay').classList.remove('active');
            if(completingTaskId) {
                const t = appData.tasks.find(x => x.id === completingTaskId);
                if(t) {
                    t.status = 'completed';
                    t.completedDate = toDateStr(new Date());
                    calculateSchedule();
                }
                completingTaskId = null;
            }
        };

        window.editTaskAction = function(id) {
            window.closeBottomSheet();
            window.openEditModal(id);
        };
        
        window.deleteTaskAction = function(id) {
            deleteTargetId = id;
            window.closeBottomSheet();
            document.getElementById('confirmDeleteModal').classList.add('active');
        };

        window.executeDelete = function() {
            if(deleteTargetId) {
                appData.tasks = appData.tasks.filter(x => x.id !== deleteTargetId);
                saveData(); 
                calculateSchedule(); 
                window.closeModal('confirmDeleteModal');
                deleteTargetId = null;
            }
        };

        window.togglePauseAction = function(id) {
            const t = appData.tasks.find(x => x.id === id);
            if(t) {
                t.status = (t.status === 'paused') ? 'active' : 'paused';
                calculateSchedule(); window.closeBottomSheet();
            }
        };
        window.toggleLockAction = function(id) {
             const t = appData.tasks.find(x => x.id === id);
             if(t) {
                 t.locked = !t.locked;
                 if(t.locked && !t.manualStartDate) t.manualStartDate = t.computedStartDate || TODAY_STR;
                 calculateSchedule(); window.closeBottomSheet();
             }
        };

        window.openTagManager = function() {
            const container = document.getElementById('tagListContainer');
            container.innerHTML = appData.settings.tags.map(tag => `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center; border-bottom:1px dashed #eee; padding-bottom:4px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:16px; height:16px; background:${tag.color}; border-radius:4px;"></div>
                        <span>${tag.name}</span>
                    </div>
                    <i class="fa-solid fa-trash" style="color:red; cursor:pointer;" onclick="deleteTag(${tag.id})"></i>
                </div>
            `).join('');
            window.openModal('tagManagerModal');
        };
        window.addTag = function() {
            const name = document.getElementById('newTagName').value;
            const color = document.getElementById('newTagColor').value;
            if(name) {
                appData.settings.tags.push({ id: Date.now(), name, color });
                window.openTagManager();
                if(document.getElementById('addTaskModal').classList.contains('active')) {
                     const container = document.getElementById('multiTagContainer');
                     const currentIds = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
                     populateMultiTag(currentIds);
                }
            }
        };
        window.deleteTag = function(id) {
            appData.settings.tags = appData.settings.tags.filter(t => t.id !== id);
            window.openTagManager();
            const container = document.getElementById('multiTagContainer');
            const currentIds = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
            populateMultiTag(currentIds);
        };

        // Phase 18 Fix: Proper navigation reset
        window.goHome = function() {
            document.getElementById('rewardPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'none';
            document.getElementById('statsPage').style.display = 'none';
            document.querySelectorAll('.main-content-element').forEach(el => el.style.display = '');
            if(document.querySelector('.sidebar').classList.contains('open')) window.toggleSidebar();
            window.resetToToday();
        };
        
        // --- 4. Sidebar Handling ---
        
        let activeTab = 'priority';
        window.switchTab = function(t) { 
            activeTab = t; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            if(t==='priority' || t==='backlog' || t==='paused') {
                document.querySelectorAll('.tab-btn').forEach(b => {
                   if(b.textContent === (t==='priority'?'æ’åº':(t==='backlog'?'å¾…è¾¦':'æš«åœ'))) b.classList.add('active');
                });
            }
            window.renderSidebar(); 
        };
        
        function getTagsHtml(task) {
            const ids = task.tagIds || [];
            if(ids.length === 0) return '';
            return `<div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;">` + 
                ids.map(id => {
                    const t = appData.settings.tags.find(x => x.id == id);
                    if(!t) return '';
                    return `<span style="font-size:0.65rem; padding:2px 6px; border-radius:4px; background:${t.color}; color:#333; font-weight:700;">${t.name}</span>`;
                }).join('') + 
            `</div>`;
        }

        window.renderSidebar = function() {
            const con = document.getElementById('sidebarContent'); con.innerHTML = '';
            
            if (activeTab === 'archive') {
                con.innerHTML = `<h3 style="margin-top:0; color:var(--primary-color);">æ­·å²å­˜æª”</h3>`;
                const completed = appData.tasks.filter(t => t.status === 'completed')
                    .sort((a,b) => (b.completedDate||'').localeCompare(a.completedDate||''));
                
                if(completed.length === 0) {
                     con.innerHTML += `<div style="text-align:center; color:#999; margin-top:20px;">å°šç„¡å®Œæˆä»»å‹™</div>`;
                     return;
                }

                let currentGrp = '';
                completed.forEach(t => {
                    const d = t.completedDate || 'æœªçŸ¥æ—¥æœŸ';
                    const grp = d.slice(0, 7); 
                    if (grp !== currentGrp) {
                        currentGrp = grp;
                        con.innerHTML += `<div class="archive-group-title">${grp}</div>`;
                    }
                    const el = document.createElement('div');
                    el.className = 'sortable-item';
                    el.style.flexDirection = 'column';
                    el.style.alignItems = 'flex-start';
                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <b>${t.title}</b>
                            <small style="color:#888">${t.loggedHours}h</small>
                        </div>
                        ${t.price ? `<div style="font-size:0.75rem; color:var(--light-text);">$${t.price}</div>` : ''}
                        ${getTagsHtml(t)}
                    `;
                    el.onclick = () => window.openBottomSheetFromId(t.id);
                    con.appendChild(el);
                });
                return;
            }

            let items = [];
            
            if(activeTab==='priority') items = appData.tasks.filter(t => t.status==='active' && !t.locked).sort((a,b)=>a.priorityOrder-b.priorityOrder);
            else if(activeTab==='backlog') items = appData.tasks.filter(t => t.status==='backlog');
            else items = appData.tasks.filter(t => t.status==='paused');

            items.forEach((t, idx) => {
                const el = document.createElement('div'); 
                el.className = 'sortable-item';
                el.setAttribute('data-id', t.id); 
                
                const commonContent = `
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <b>${t.title}</b> 
                            <small>${t.estimatedHours}h</small>
                        </div>
                        ${getTagsHtml(t)}
                    </div>
                `;

                if(activeTab === 'priority') {
                    el.innerHTML = `
                        ${commonContent}
                        <i class="fa-solid fa-inbox" style="padding:8px; color:var(--light-text); cursor:pointer; margin-left:8px;" onclick="event.stopPropagation(); window.moveToBacklog('${t.id}')"></i>
                    `;
                } else {
                    el.innerHTML = commonContent;
                }
                
                if(activeTab === 'priority') {
                    initSidebarTouchSort(el, idx);
                    el.onclick = () => window.openBottomSheetFromId(t.id);
                    el.draggable = true;
                    el.ondragstart = (e) => { e.dataTransfer.setData('index', idx); el.classList.add('dragging'); };
                    el.ondragend = () => el.classList.remove('dragging');
                    el.ondragover = (e) => e.preventDefault();
                    el.ondrop = (e) => {
                        e.preventDefault();
                        const fromIdx = parseInt(e.dataTransfer.getData('index'));
                        const toIdx = idx;
                        if(fromIdx !== toIdx) {
                            const currentList = appData.tasks.filter(t => t.status==='active' && !t.locked).sort((a,b)=>a.priorityOrder-b.priorityOrder);
                            const moved = currentList.splice(fromIdx, 1)[0];
                            currentList.splice(toIdx, 0, moved);
                            currentList.forEach((item, i) => item.priorityOrder = i);
                            calculateSchedule(); window.renderSidebar();
                        }
                    };
                }

                if(activeTab==='backlog') {
                    el.innerHTML += `<i class="fa-solid fa-arrow-up" style="cursor:pointer; margin-left:8px;" onclick="window.activateTask('${t.id}')"></i>`;
                }
                
                if(activeTab==='paused') {
                    el.innerHTML += `<div style="display:flex; gap:10px; margin-left:8px;">
                        <i class="fa-solid fa-arrow-up" style="cursor:pointer; color:var(--primary-color);" onclick="window.restorePausedTask('${t.id}')"></i>
                    </div>`;
                    el.onclick = (e) => {
                        if(e.target.tagName !== 'I') window.openEditModal(t.id);
                    };
                    el.style.cursor = 'pointer';
                }
                con.appendChild(el);
            });
        }

        window.activateTask = function(id) { const t=appData.tasks.find(x=>x.id===id); if(t){t.status='active'; calculateSchedule(); window.renderSidebar(); window.switchTab('priority');} };
        
        window.moveToBacklog = function(id) {
            const t = appData.tasks.find(x => x.id === id);
            if(t) {
                t.status = 'backlog';
                t.locked = false;
                delete t.manualStartDate;
                delete t.computedStartDate;
                delete t.computedEndDate;
                calculateSchedule();
                window.renderSidebar();
            }
        };

        window.restorePausedTask = function(id) {
            const t = appData.tasks.find(x => x.id === id);
            if(t) {
                t.status = 'active';
                const minP = Math.min(...appData.tasks.map(x=>x.priorityOrder||0));
                t.priorityOrder = minP - 1;
                calculateSchedule(); window.renderSidebar(); window.switchTab('priority');
            }
        };

        // --- 5. Toggles ---
        
        window.toggleSidebar = function() { 
            document.querySelector('.sidebar').classList.toggle('open'); 
            document.querySelector('.sidebar-overlay').classList.toggle('open'); 
        };
        
        window.toggleFab = function() { 
            document.getElementById('fabMenu').classList.toggle('active'); 
        };
        
        window.openModal = function(id) { 
            document.getElementById(id).classList.add('active'); 
            if(id === 'addTaskModal') {
                const taskId = document.getElementById('editTaskId').value;
                const t = taskId ? appData.tasks.find(x => x.id === taskId) : null;
                window.populateMultiTag(t ? t.tagIds : []);
                window.renderSubItemView();
            }
        };
        window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };

        // --- MISSING CORE TASK LOGIC (Restored Phase 20 Definitions) ---

        window.openEditModal = function(id = null) {
            const isNew = !id;
            document.getElementById('editTaskId').value = id || '';
            document.getElementById('modalTitleText').textContent = isNew ? 'æ–°å¢ä»»å‹™' : 'ç·¨è¼¯ä»»å‹™';
            
            const itemsContainer = document.getElementById('newTaskItemsContainer');
            itemsContainer.innerHTML = appData.settings.workItems.map((item, i) => `
                <div class="checkbox-pill">
                    <input type="checkbox" id="item-${i}" value="${item.hours}" data-name="${item.name}" onchange="window.updateEstimatedHours()">
                    <label for="item-${i}">${item.name}</label>
                </div>
            `).join('');

            if (!isNew) {
                const t = appData.tasks.find(x => x.id === id);
                document.getElementById('newTaskTitle').value = t.title;
                document.getElementById('newTaskPrice').value = t.price || 0;
                document.getElementById('newTaskHours').value = t.estimatedHours;
                document.getElementById('newTaskNotes').value = t.notes || '';
                document.getElementById('newTaskDeadline').value = t.deadline || '';
                document.getElementById('newTaskStartDate').value = t.manualStartDate || '';
                window.tempSubItems = t.subItems ? JSON.parse(JSON.stringify(t.subItems)) : [];
                window.tempTagIds = t.tagIds || [];
            } else {
                document.getElementById('newTaskTitle').value = '';
                document.getElementById('newTaskPrice').value = '';
                document.getElementById('newTaskHours').value = 0;
                document.getElementById('newTaskNotes').value = '';
                document.getElementById('newTaskDeadline').value = '';
                document.getElementById('newTaskStartDate').value = '';
                window.tempSubItems = [];
                window.tempTagIds = [];
            }
            
            window.openModal('addTaskModal');
            window.updateHourlyRate();
        };

        window.updateEstimatedHours = function() {
            const checks = document.querySelectorAll('#newTaskItemsContainer input:checked');
            let total = 0;
            checks.forEach(c => total += parseFloat(c.value));
            document.getElementById('newTaskHours').value = total;
            window.updateHourlyRate();
        };

        window.updateHourlyRate = function() {
            const price = parseFloat(document.getElementById('newTaskPrice').value) || 0;
            const hours = parseFloat(document.getElementById('newTaskHours').value) || 0;
            const rate = hours > 0 ? Math.round(price / hours) : 0;
            document.getElementById('hourlyRateDisplay').textContent = `é ä¼°æ™‚è–ª: $${rate}`;
        };

        window.populateMultiTag = function(selectedIds = []) {
            const container = document.getElementById('multiTagContainer');
            container.innerHTML = appData.settings.tags.map(tag => {
                const checked = selectedIds.includes(tag.id) ? 'checked' : '';
                return `
                    <div class="checkbox-pill">
                        <input type="checkbox" id="tagCheck-${tag.id}" value="${tag.id}" ${checked}>
                        <label for="tagCheck-${tag.id}" style="border-color:${tag.color};">${tag.name}</label>
                    </div>
                `;
            }).join('');
        };

        window.renderSubItemView = function() {
            const container = document.getElementById('subItemViewList');
            if (!window.tempSubItems || window.tempSubItems.length === 0) {
                container.innerHTML = '<div style="padding:10px; color:#AAA; text-align:center; font-size:0.8rem;">å°šç„¡å­é …ç›®æµç¨‹</div>';
                return;
            }
            container.innerHTML = window.tempSubItems.map((item, idx) => `
                <div class="sub-item-view-row ${item.done ? 'done' : ''}" onclick="window.toggleSubItemDone(${idx})">
                    <i class="fa-regular ${item.done ? 'fa-square-check' : 'fa-square'}"></i>
                    <span>${item.text} ${item.loggedAtCheck || ''}</span>
                </div>
            `).join('');
        };

        window.toggleSubItemDone = function(idx) {
            window.tempSubItems[idx].done = !window.tempSubItems[idx].done;
            window.renderSubItemView();
        };

        window.submitNewTask = function() {
            const id = document.getElementById('editTaskId').value;
            const title = document.getElementById('newTaskTitle').value;
            const hours = parseFloat(document.getElementById('newTaskHours').value);
            const price = parseFloat(document.getElementById('newTaskPrice').value);
            const deadline = document.getElementById('newTaskDeadline').value;
            const notes = document.getElementById('newTaskNotes').value;
            const startDate = document.getElementById('newTaskStartDate').value;
            
            const selectedTagIds = Array.from(document.querySelectorAll('#multiTagContainer input:checked')).map(cb => parseInt(cb.value));

            if (!title || hours <= 0) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }

            if (id) {
                const t = appData.tasks.find(x => x.id === id);
                t.title = title; t.estimatedHours = hours; t.price = price;
                t.deadline = deadline; t.notes = notes; t.tagIds = selectedTagIds;
                t.manualStartDate = startDate; t.locked = !!startDate;
                t.subItems = window.tempSubItems;
            } else {
                const maxP = appData.tasks.length > 0 ? Math.max(...appData.tasks.map(t => t.priorityOrder || 0)) : 0;
                appData.tasks.push({
                    id: Date.now().toString(),
                    title, estimatedHours: hours, price, deadline, notes,
                    tagIds: selectedTagIds,
                    manualStartDate: startDate,
                    locked: !!startDate,
                    priorityOrder: maxP + 1,
                    status: 'active',
                    loggedHours: 0,
                    subItems: window.tempSubItems
                });
            }
            calculateSchedule(); window.closeModal('addTaskModal');
        };

        // --- Rest Day Logic ---

        window.openRestModal = function(dateStr = TODAY_STR) {
            const rest = appData.restDays.find(r => r.date === dateStr);
            document.getElementById('restDateInput').value = dateStr;
            document.getElementById('btnDeleteRest').style.display = rest ? 'block' : 'none';
            
            if (rest) {
                document.getElementById('restFullDay').checked = rest.isFullDay;
                document.getElementById('restStart').value = rest.start || '09:00';
                document.getElementById('restEnd').value = rest.end || '13:00';
            } else {
                document.getElementById('restFullDay').checked = true;
            }
            window.toggleRestTimeInput();
            window.updateRestQuotaInfo(dateStr);
            window.openModal('restModal');
        };

        window.toggleRestTimeInput = function() {
            const fullDay = document.getElementById('restFullDay').checked;
            document.getElementById('restTimeContainer').style.display = fullDay ? 'none' : 'block';
        };

        window.updateRestQuotaInfo = function(dateStr) {
            const m = dateStr.slice(0, 7);
            const month = m.split('-')[1];
            
            // 1. Calculate Monthly Quota
            const usedCount = appData.restDays.filter(r => r.date.startsWith(m)).length;
            const limit = appData.settings.monthlyQuota;
            let balance = limit - usedCount;
            
            // 2. Calculate Rewards
            const balances = {};
            appData.rewardCategories.forEach(c => balances[c.id] = 0);
            appData.rewardLogs.forEach(l => {
                if(balances[l.categoryId] !== undefined) {
                    if(l.type === 'earn') balances[l.categoryId] += l.amount;
                    else balances[l.categoryId] -= l.amount;
                }
            });
            
            let resDays = 0;
            let resHours = 0;
            appData.rewardCategories.forEach(c => {
                const b = balances[c.id];
                if(b > 0) {
                    if(c.unit === 'å¤©') resDays += b;
                    if(c.unit === 'å°æ™‚') resHours += b;
                }
            });
            
            const hasReward = (resDays > 0 || resHours > 0);
            
            // 3. Logic: Mask negative balance if rewards exist
            let displayBalance = balance;
            let isDeficit = balance < 0;
            
            if (isDeficit && hasReward) {
                displayBalance = 0; 
                isDeficit = false; // Treat as covered
            }
            
            // 4. Render
            const el = document.getElementById('restQuotaInfo');
            
            // Styles
            const styleNormal = 'background:#E3F2FD; color:#1565C0;';
            const styleWarn = 'background:#FFEBEE; color:#C62828;';
            const styleCovered = 'background:#E8F5E9; color:#2E7D32;'; // Green for covered
            
            let finalStyle = styleNormal;
            if (balance < 0) {
                if (hasReward) finalStyle = styleCovered;
                else finalStyle = styleWarn;
            }
            
            el.style.cssText = `padding:10px; border-radius:8px; font-size:0.9rem; ${finalStyle}`;
            
            let balanceDisplayStr = displayBalance;
            
            let html = `<div style="font-weight:700;">${month}æœˆé¡åº¦: ${balanceDisplayStr} <span style="font-weight:normal; font-size:0.8em;">(å·²ä¼‘ ${usedCount}/${limit})</span></div>`;
            
            if (hasReward) {
                html += `<div style="margin-top:5px; padding-top:5px; border-top:1px dashed rgba(0,0,0,0.1); display:flex; align-items:center; gap:6px;">
                    <i class="fa-solid fa-gift"></i> 
                    <span>çå‹µå„²å‚™: <b>${resDays}</b> å¤© <b>${resHours}</b> å°æ™‚</span>
                </div>`;
            }
            
            el.innerHTML = html;
        };

        window.submitRestDay = function() {
            const date = document.getElementById('restDateInput').value;
            const isFullDay = document.getElementById('restFullDay').checked;
            const start = document.getElementById('restStart').value;
            const end = document.getElementById('restEnd').value;
            
            appData.restDays = appData.restDays.filter(r => r.date !== date);
            appData.restDays.push({ date, isFullDay, start, end });
            calculateSchedule(); window.closeModal('restModal');
        };

        window.deleteRestDay = function() {
            const date = document.getElementById('restDateInput').value;
            appData.restDays = appData.restDays.filter(r => r.date !== date);
            calculateSchedule(); window.closeModal('restModal');
        };

        window.addEventListener('DOMContentLoaded', () => initData());
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
